<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Module Duy·ªát B√°o C√°o - NCTN 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#ec4899',
            'muted': '#f8fafc',
            'ink': '#0b1324'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #ec4899;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#be123c 0%,#ffe4e6 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    .table-zebra tbody tr:nth-child(even){ background-color:#f8fafc; }
    .table-vdiv{ border-collapse: separate; border-spacing: 0; }
    .table-vdiv th+th, .table-vdiv td+td{ border-left:1px solid #e5e7eb; }
    .submit-btn{background:linear-gradient(135deg,#ec4899 0%,#f9a8d4 100%);box-shadow:0 4px 6px rgba(236,72,153,.1),0 1px 3px rgba(236,72,153,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(236,72,153,.12),0 3px 6px rgba(236,72,153,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .badge{background:rgba(236,72,153,.15);color:#9f1239;border:1px solid rgba(236,72,153,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .group-btn{padding:0.5rem 1rem;border-radius:9999px;border:1px solid #fecdd3;background:#fff1f2;color:#9f1239;font-weight:600;transition:all .2s}
    .group-btn:hover{background:#ffe4e6;border-color:#fda4af}
    .group-btn.active{background:linear-gradient(135deg,#ec4899 0%,#f9a8d4 100%);color:#fff;border-color:#ec4899}
    .assign-tab-btn.active{border-bottom-color:#ec4899!important;color:#ec4899;font-weight:600}
  </style>
</head>
<body class="bg-muted min-h-screen text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
  <header class="header-container w-full">
    <div class="relative z-10 w-full p-8 md:p-10">
      <div class="flex items-center space-x-2 mb-3">
        <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold text-white" style="background-color: rgba(255,255,255,0.15); backdrop-filter: blur(5px);">NCTN 2</div>
      </div>
      <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">Module Duy·ªát B√°o C√°o</h1>
      <p class="text-rose-100 text-sm md:text-base">D√†nh cho Th·∫ø Vi·ªát - Tr√¢m anh th·∫ø phi·ªát.</p>
    </div>
  </header>

  <main class="w-full p-4 md:p-6">
    <div class="mb-4 flex items-center gap-2 flex-wrap">
      <button class="px-3 py-1 rounded-full border border-rose-200 bg-rose-50/30 text-primary-blue hover:bg-rose-50 tab-btn active" data-target="form-approve">Duy·ªát b√°o c√°o</button>
      <button class="px-3 py-1 rounded-full border border-rose-200 bg-rose-50/30 text-primary-blue hover:bg-rose-50 tab-btn" data-target="form-assign">Ph√¢n c√¥ng</button>
      <button class="px-3 py-1 rounded-full border border-rose-200 bg-rose-50/30 text-primary-blue hover:bg-rose-50 tab-btn" data-target="form-statistics">Th·ªëng k√™</button>
    </div>

    <section id="form-approve" class="bg-white p-4 md:p-6 rounded-xl shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-rose-800">Danh s√°ch b√°o c√°o ch·ªù duy·ªát</h2>
        <div class="flex items-center gap-2 text-xs text-gray-500">
          <label for="secret-code" class="hidden md:block">M√£ b·∫£o m·∫≠t</label>
          <input id="secret-code" type="password" placeholder="M√£ b·∫£o m·∫≠t" autocomplete="off" class="border border-rose-200 rounded bg-white text-xs px-2 py-1" style="min-width:160px" />
        </div>
      </div>

      <!-- Group Filter -->
      <div class="mb-4 flex items-center gap-3 flex-wrap">
        <span class="text-sm font-medium text-gray-700">Ch·ªçn nh√≥m:</span>
        <button id="btn-group-all" class="group-btn active" data-group="all">T·∫•t c·∫£</button>
        <button id="btn-group-nctn2" class="group-btn" data-group="nctn2">
          <span class="mr-1">üë•</span> Ph√≤ng NCTN 2 <span class="text-xs opacity-75">(8)</span>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
        <div class="md:col-span-3">
          <label class="block text-sm text-gray-700 mb-1">T·ª´ kh√≥a</label>
          <input id="flt-q" type="text" placeholder="M√£/ti√™u ƒë·ªÅ/ng∆∞·ªùi l·∫≠p" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">Tr·∫°ng th√°i</label>
          <select id="flt-status" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white">
            <option value="Pending1">Ch·ªù ph√™ duy·ªát</option>
            <option value="Pending2" selected>Tr∆∞·ªüng nh√≥m Review</option>
            <option value="Approved">Done</option>
            <option value="TestBen">Test b·ªÅn</option>
            <option value="ChangesRequested">ƒêang s·ª≠a</option>
            <option value="All">T·∫•t c·∫£</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">T·ª´ ng√†y</label>
          <input id="flt-from" type="date" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">ƒê·∫øn ng√†y</label>
          <input id="flt-to" type="date" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" />
        </div>
        <div class="md:col-span-3 flex items-end gap-2">
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-600">Ch·∫ø ƒë·ªô</label>
            <select id="flt-mode" class="border border-rose-200 rounded bg-white text-sm px-2 py-1">
              <option value="All" selected>T·∫•t c·∫£</option>
              <option value="Day">Ng√†y</option>
              <option value="Week">Tu·∫ßn</option>
              <option value="Month">Th√°ng</option>
            </select>
          </div>
          <button id="btn-search" class="submit-btn px-4 py-2 text-white font-semibold">Tra c·ª©u</button>
          <button id="btn-reset" class="px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">X√≥a l·ªçc</button>
        </div>
      </div>

      <div class="mt-2 overflow-auto border border-rose-100 rounded-lg bg-rose-50/30">
        <table class="min-w-[1100px] w-full text-sm table-zebra table-vdiv">
          <thead class="bg-gradient-to-r from-rose-100 to-rose-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[120px]">M√£ b√°o c√°o</th>
              <th class="px-3 py-2 min-w-[260px]">Ti√™u ƒë·ªÅ</th>
              <th class="px-3 py-2 min-w-[160px]">Ng∆∞·ªùi l·∫≠p</th>
              <th class="px-3 py-2 min-w-[140px]">Ng√†y n·ªôp</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n mong mu·ªën</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n ƒë√°nh gi√°</th>
              <th class="px-3 py-2 min-w-[120px]">Tr·∫°ng th√°i</th>
              <th class="px-3 py-2 min-w-[160px]">K·∫øt lu·∫≠n</th>
              <th class="px-3 py-2 min-w-[220px]">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="list-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>

      <div id="pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="page-info">Trang 1/1 (0 d√≤ng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hi·ªÉn th·ªã</label>
          <select id="page-size" class="border border-rose-300 rounded-lg bg-rose-50 p-1 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <button id="prev" class="px-3 py-1 rounded-lg border border-rose-200 text-rose-700 bg-white hover:bg-rose-50">Tr∆∞·ªõc</button>
          <button id="next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>
    </section>

    <!-- Section Ph√¢n c√¥ng -->
    <section id="form-assign" class="bg-white p-4 md:p-6 rounded-xl shadow-md" style="display:none">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-rose-800">Ph√¢n c√¥ng t√°c v·ª•</h2>
        <button id="btn-reload-assign" class="px-3 py-1 rounded-lg border border-rose-200 bg-rose-50 hover:bg-rose-100 text-rose-700 text-sm">
          üîÑ L√†m m·ªõi
        </button>
      </div>

      <!-- Tab ph√¢n lo·∫°i -->
      <div class="mb-4 flex items-center gap-3 flex-wrap border-b border-rose-100">
        <button id="btn-assign-tab-unassigned" class="px-4 py-2 rounded-t-lg border-b-2 border-transparent hover:bg-rose-50 assign-tab-btn active" data-tab="unassigned">
          Ch∆∞a ph√¢n c√¥ng <span id="count-unassigned" class="ml-2 px-2 py-0.5 rounded-full bg-rose-200 text-rose-800 text-xs font-semibold">0</span>
        </button>
        <button id="btn-assign-tab-assigned" class="px-4 py-2 rounded-t-lg border-b-2 border-transparent hover:bg-rose-50 assign-tab-btn" data-tab="assigned">
          ƒê√£ ph√¢n c√¥ng <span id="count-assigned" class="ml-2 px-2 py-0.5 rounded-full bg-green-200 text-green-800 text-xs font-semibold">0</span>
        </button>
      </div>

      <!-- B·ªô l·ªçc -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">T·ª´ kh√≥a</label>
          <input id="assign-flt-q" type="text" placeholder="M√£/ti√™u ƒë·ªÅ/ng∆∞·ªùi y√™u c·∫ßu" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">T·ª´ ng√†y</label>
          <input id="assign-flt-from" type="date" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">ƒê·∫øn ng√†y</label>
          <input id="assign-flt-to" type="date" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" />
        </div>
      </div>

      <!-- B·∫£ng danh s√°ch -->
      <div class="mt-2 overflow-auto border border-rose-100 rounded-lg bg-rose-50/30">
        <table class="min-w-[1200px] w-full text-sm table-zebra table-vdiv">
          <thead class="bg-gradient-to-r from-rose-100 to-rose-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[120px]">M√£ t√°c v·ª•</th>
              <th class="px-3 py-2 min-w-[280px]">T√™n t√°c v·ª•</th>
              <th class="px-3 py-2 min-w-[160px]">Ng∆∞·ªùi y√™u c·∫ßu</th>
              <th class="px-3 py-2 min-w-[140px]">Ng√†y y√™u c·∫ßu</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n mong mu·ªën</th>
              <th class="px-3 py-2 min-w-[160px]">Ng∆∞·ªùi th·ª±c hi·ªán</th>
              <th class="px-3 py-2 min-w-[140px]">Tr·∫°ng th√°i</th>
              <th class="px-3 py-2 min-w-[200px]">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="assign-list-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="assign-pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="assign-page-info">Trang 1/1 (0 d√≤ng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hi·ªÉn th·ªã</label>
          <select id="assign-page-size" class="border border-rose-300 rounded-lg bg-rose-50 p-1 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <button id="assign-prev" class="px-3 py-1 rounded-lg border border-rose-200 text-rose-700 bg-white hover:bg-rose-50">Tr∆∞·ªõc</button>
          <button id="assign-next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>
    </section>

    <!-- Section Th·ªëng k√™ -->
    <section id="form-statistics" class="bg-white p-4 md:p-6 rounded-xl shadow-md" style="display:none">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-rose-800">Th·ªëng k√™ b√°o c√°o</h2>
        <button id="btn-refresh-stats" class="px-3 py-1 rounded-lg border border-rose-200 bg-rose-50 hover:bg-rose-100 text-rose-700 text-sm">
          üîÑ L√†m m·ªõi
        </button>
      </div>

      <!-- B·ªô l·ªçc th·ªëng k√™ -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
        <div>
          <label class="block text-sm text-gray-700 mb-1">T·ª´ ng√†y</label>
          <input id="stats-from" type="date" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">ƒê·∫øn ng√†y</label>
          <input id="stats-to" type="date" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">Nh√≥m</label>
          <select id="stats-group" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white">
            <option value="all">T·∫•t c·∫£</option>
            <option value="nctn2">Ph√≤ng NCTN 2</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="btn-apply-stats" class="submit-btn px-4 py-2 text-white font-semibold w-full">√Åp d·ª•ng</button>
        </div>
      </div>

      <!-- Th·∫ª th·ªëng k√™ t·ªïng quan -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-rose-50 to-rose-100 p-4 rounded-lg border border-rose-200">
          <div class="text-sm text-rose-700 font-medium mb-1">T·ªïng s·ªë b√°o c√°o</div>
          <div class="text-2xl font-bold text-rose-800" id="stat-total">0</div>
        </div>
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
          <div class="text-sm text-blue-700 font-medium mb-1">Ch·ªù duy·ªát</div>
          <div class="text-2xl font-bold text-blue-800" id="stat-pending">0</div>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
          <div class="text-sm text-green-700 font-medium mb-1">ƒê√£ duy·ªát</div>
          <div class="text-2xl font-bold text-green-800" id="stat-approved">0</div>
        </div>
        <div class="bg-gradient-to-br from-amber-50 to-amber-100 p-4 rounded-lg border border-amber-200">
          <div class="text-sm text-amber-700 font-medium mb-1">ƒêang s·ª≠a</div>
          <div class="text-2xl font-bold text-amber-800" id="stat-changes">0</div>
        </div>
      </div>

      <!-- Bi·ªÉu ƒë·ªì v√† b·∫£ng th·ªëng k√™ -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Bi·ªÉu ƒë·ªì tr·∫°ng th√°i -->
        <div class="bg-rose-50/30 p-4 rounded-lg border border-rose-100">
          <h3 class="text-lg font-semibold text-rose-800 mb-4">Ph√¢n b·ªë tr·∫°ng th√°i</h3>
          <canvas id="chart-status" style="max-height:300px"></canvas>
        </div>

        <!-- Bi·ªÉu ƒë·ªì theo ng∆∞·ªùi l·∫≠p -->
        <div class="bg-rose-50/30 p-4 rounded-lg border border-rose-100">
          <h3 class="text-lg font-semibold text-rose-800 mb-4">S·ªë l∆∞·ª£ng theo ng∆∞·ªùi l·∫≠p</h3>
          <canvas id="chart-reporter" style="max-height:300px"></canvas>
        </div>
      </div>

      <!-- B·∫£ng th·ªëng k√™ chi ti·∫øt -->
      <div class="bg-rose-50/30 p-4 rounded-lg border border-rose-100">
        <h3 class="text-lg font-semibold text-rose-800 mb-4">Th·ªëng k√™ theo ng∆∞·ªùi l·∫≠p</h3>
        <div class="overflow-auto">
          <table class="min-w-full w-full text-sm table-zebra">
            <thead class="bg-gradient-to-r from-rose-100 to-rose-50">
              <tr class="text-left text-gray-700">
                <th class="px-3 py-2">Ng∆∞·ªùi l·∫≠p</th>
                <th class="px-3 py-2 text-center">T·ªïng s·ªë</th>
                <th class="px-3 py-2 text-center">Ch·ªù duy·ªát</th>
                <th class="px-3 py-2 text-center">ƒê√£ duy·ªát</th>
                <th class="px-3 py-2 text-center">ƒêang s·ª≠a</th>
                <th class="px-3 py-2 text-center">T·ª´ ch·ªëi</th>
              </tr>
            </thead>
            <tbody id="stats-table-body" class="divide-y divide-gray-100">
              <tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Approve -->
  <div id="modal-approve" class="modal" aria-hidden="true">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-4">
      <h3 class="text-lg font-semibold text-rose-800 mb-1">Duy·ªát b√°o c√°o</h3>
      <p class="text-sm text-gray-600 mb-3">Nh·∫≠p b√¨nh lu·∫≠n (kh√¥ng b·∫Øt bu·ªôc)</p>
      <textarea id="approve-comment" rows="4" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" placeholder="Ghi ch√∫ cho ng∆∞·ªùi l·∫≠p..."></textarea>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button data-close="modal-approve" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">H·ªßy</button>
        <button id="approve-do" class="submit-btn px-4 py-2 text-white font-semibold">X√°c nh·∫≠n duy·ªát</button>
      </div>
    </div>
  </div>

  <!-- Modal Reject -->
  <div id="modal-reject" class="modal" aria-hidden="true">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-4">
      <h3 class="text-lg font-semibold text-red-700 mb-1">T·ª´ ch·ªëi b√°o c√°o</h3>
      <p class="text-sm text-gray-600 mb-3">Vui l√≤ng n√™u l√Ω do</p>
      <textarea id="reject-reason" rows="4" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" placeholder="L√Ω do t·ª´ ch·ªëi..."></textarea>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button data-close="modal-reject" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">H·ªßy</button>
        <button id="reject-do" class="px-4 py-2 rounded-full text-white font-semibold" style="background:#db2777">X√°c nh·∫≠n t·ª´ ch·ªëi</button>
      </div>
    </div>
  </div>

  <!-- Modal Request Changes -->
  <div id="modal-req" class="modal" aria-hidden="true">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-4">
      <h3 class="text-lg font-semibold text-amber-700 mb-1">Y√™u c·∫ßu b·ªï sung</h3>
      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">B√¨nh lu·∫≠n y√™u c·∫ßu</label>
        <textarea id="req-comment" rows="4" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" placeholder="N·ªôi dung c·∫ßn b·ªï sung..."></textarea>
      </div>
      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">H·∫°n b·ªï sung (kh√¥ng b·∫Øt bu·ªôc)</label>
        <input id="req-due" type="date" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" />
      </div>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button data-close="modal-req" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">H·ªßy</button>
        <button id="req-do" class="px-4 py-2 rounded-full text-white font-semibold" style="background:#f472b6">G·ª≠i y√™u c·∫ßu</button>
      </div>
    </div>
  </div>

  <!-- Modal Assign -->
  <div id="modal-assign" class="modal" aria-hidden="true">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-4">
      <h3 id="assign-modal-title" class="text-lg font-semibold text-rose-800 mb-1">Ph√¢n c√¥ng t√°c v·ª•</h3>
      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">M√£ t√°c v·ª•</label>
        <input id="assign-task-code" type="text" readonly class="w-full border border-rose-300 rounded-lg bg-gray-50 p-2 text-gray-600" />
      </div>
      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">T√™n t√°c v·ª•</label>
        <input id="assign-task-title" type="text" readonly class="w-full border border-rose-300 rounded-lg bg-gray-50 p-2 text-gray-600" />
      </div>
      <div class="mb-3" id="assign-current-person-container" style="display:none">
        <label class="block text-sm text-gray-700 mb-1">Ng∆∞·ªùi th·ª±c hi·ªán hi·ªán t·∫°i</label>
        <input id="assign-current-person" type="text" readonly class="w-full border border-rose-300 rounded-lg bg-amber-50 p-2 text-amber-700 font-medium" />
      </div>
      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">Ng∆∞·ªùi th·ª±c hi·ªán <span class="text-red-500">*</span></label>
        <select id="assign-person" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white">
          <option value="">-- Ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán --</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">Ghi ch√∫ (kh√¥ng b·∫Øt bu·ªôc)</label>
        <textarea id="assign-note" rows="3" class="w-full border border-rose-300 rounded-lg bg-rose-50 p-2 focus:outline-none focus:ring-2 focus:ring-rose-200 focus:bg-white" placeholder="Ghi ch√∫ ph√¢n c√¥ng..."></textarea>
      </div>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button data-close="modal-assign" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">H·ªßy</button>
        <button id="assign-do" class="submit-btn px-4 py-2 text-white font-semibold">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- Modal Report Preview -->
  <div id="modal-report" class="modal" aria-hidden="true">
    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-0 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-2 border-b">
        <div class="text-sm text-gray-700">Xem b√°o c√°o: <span id="report-title" class="font-semibold"></span></div>
        <div class="flex items-center gap-2">
          <a id="report-open-new" href="#" target="_blank" class="text-rose-600 text-sm underline">M·ªü tab m·ªõi</a>
          <button data-close="modal-report" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">ƒê√≥ng</button>
        </div>
      </div>
      <div class="h-[70vh]">
        <iframe id="report-frame" src="about:blank" class="w-full h-full" title="Report preview"></iframe>
      </div>
    </div>
  </div>

  <!-- Modal Task Detail -->
  <div id="modal-task" class="modal" aria-hidden="true">
    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-0 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-2 border-b">
        <div class="text-sm text-gray-700">Chi ti·∫øt t√°c v·ª•: <span id="task-title" class="font-semibold"></span></div>
        <div class="flex items-center gap-2">
          <a id="task-open-new" href="#" target="_blank" class="text-rose-600 text-sm underline">M·ªü tab m·ªõi</a>
          <button data-close="modal-task" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">ƒê√≥ng</button>
        </div>
      </div>
      <div class="p-4 text-sm" id="task-content">ƒêang t·∫£i...</div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ===== Config
    const WEBHOOK_TEST = 'https://xcqiyibqs.tino.page/webhook/tracuutacvuNCTN2';
    const WEBHOOK_PROD = WEBHOOK_TEST.replace('/webhook-test/','/webhook/');
    const REPORTS_QUERY_URL = 'https://xcqiyibqs.tino.page/webhook/TracuutruongnhomDBmoi';
    const FORM_ACTION_URL = 'https://xcqiyibqs.tino.page/webhook/duyebaocaotruongnhomdbmoi';
    const ASSIGN_QUERY_URL = 'https://xcqiyibqs.tino.page/webhook/LaydulieuphancongNCTN2';

    // ===== Group Definitions (NCTN 2)
    const NHOM_NCTN2 = [
      'ƒê·ªó Xu√¢n Huy',
      'Tr·ªãnh Xu√¢n H·∫°nh',
      'Giang VƒÉn To√†n',
      'Nguy·ªÖn Th·∫ø Vi·ªát',
      'V≈© Ng·ªçc Di·ªáp',
      'Nguy·ªÖn Kim C∆∞∆°ng',
      'Tr·∫ßn VƒÉn Ho√†ng',
      'B√πi Ng·ªçc H√πng'
    ];

    // ===== State
    let ALL_ITEMS = [];
    let FILTERED = [];
    let CURRENT_PAGE = 1;
    let PAGE_SIZE = 20;
    let CURRENT_ITEM_ID = null;
    let CURRENT_ACTION = null;
    let SELECTED_GROUP = 'all'; // 'all' | 'nctn2'

    // ===== Assign State
    let ALL_ASSIGN_ITEMS = [];
    let ASSIGN_FILTERED = [];
    let ASSIGN_CURRENT_PAGE = 1;
    let ASSIGN_PAGE_SIZE = 20;
    let ASSIGN_CURRENT_TAB = 'unassigned'; // 'unassigned' | 'assigned'
    let ASSIGN_CURRENT_ITEM = null;
    let ASSIGN_IS_CHANGE_MODE = false; // false = ph√¢n c√¥ng m·ªõi, true = thay ƒë·ªïi ng∆∞·ªùi th·ª±c hi·ªán

    // ===== Helpers
    function normalizeVietnamese(str){
      return String(str||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    }

    function isInGroup(reporterName, group){
      if (group === 'all') return true;
      const normalized = normalizeVietnamese(reporterName);
      const targetGroup = group === 'nctn2' ? NHOM_NCTN2 : [];
      return targetGroup.some(name => normalizeVietnamese(name) === normalized);
    }

    function showToast(message, type){
      const el = document.getElementById('toast'); if (!el) return;
      el.textContent = String(message||'');
      el.style.background = type==='error' ? '#b91c1c' : '#0b1324';
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 2200);
    }

    function generateQaPdCode(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let suffix = '';
      for (let i=0; i<6; i++){ suffix += chars.charAt(Math.floor(Math.random()*chars.length)); }
      return `QA.RV.${yyyy}${mm}${dd}-${suffix}`;
    }

    function openModal(id){ const m=document.getElementById(id); if(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); } }
    function closeModal(id){ 
      const m=document.getElementById(id); 
      if(m){ 
        m.classList.remove('open'); 
        m.setAttribute('aria-hidden','true');
        // Reset modal assign khi ƒë√≥ng
        if (id === 'modal-assign') {
          ASSIGN_IS_CHANGE_MODE = false;
          ASSIGN_CURRENT_ITEM = null;
          const currentPersonContainer = document.getElementById('assign-current-person-container');
          if (currentPersonContainer) currentPersonContainer.style.display = 'none';
        }
      } 
    }

    function parseDateFlexible(s){
      try{
        const v = String(s||'').trim(); if (!v) return null;
        if (/^\d{4}-\d{2}-\d{2}/.test(v)) return new Date(v);
        const m = v.match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})/);
        if (m){ const d=Number(m[1]), mm=Number(m[2])-1, y=Number(m[3]<100?('20'+m[3]):m[3]); return new Date(y,mm,d); }
        const t = Date.parse(v); return isNaN(t)?null:new Date(t);
      }catch(_){ return null; }
    }

    function fmtDmy(s){ const d=parseDateFlexible(s); if(!d) return ''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
    function nowIsoMinute(){ const d=new Date(); const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${yy}-${mm}-${dd} ${hh}:${mi}`; }
    function nowViMinute(){ const d=new Date(); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${dd}/${mm}/${yy} ${hh}:${mi}`; }
    function appendRowParams(p, it, overrides){
      try{
        const row = Object.assign({}, it || {}, overrides || {});

        // Ch·ªâ g·ª≠i d·ªØ li·ªáu th·ª±c t·∫ø theo ƒë√∫ng t√™n tr∆∞·ªùng trong json.json (kh√¥ng c√≥ header_ v√† field_ prefix)
        if (row.id) p.append('Id', String(row.id));
        if (row.ngayYeuCauCacBen) p.append('Ng√†y y√™u c·∫ßu c·ªßa c√°c b√™n', String(row.ngayYeuCauCacBen));
        if (row.hanMongMuonCacBen) p.append('H·∫°n mong mu·ªën c·ªßa c√°c b√™n', String(row.hanMongMuonCacBen));
        if (row.ngayBatDauThucTe) p.append('Ng√†y b·∫Øt ƒë·∫ßu th·ª±c t·∫ø', String(row.ngayBatDauThucTe));
        if (row.ngayHoanThanhThucTe) p.append('Ng√†y ho√†n th√†nh th·ª±c t·∫ø', String(row.ngayHoanThanhThucTe));
        if (row.maTacVu || row.code) p.append('M√£ t√°c v·ª•', String(row.maTacVu || row.code || ''));
        if (row.tenTacVu || row.title) p.append('T√™n t√°c v·ª•', String(row.tenTacVu || row.title || ''));
        if (row.nhaCungCap) p.append('Nh√† cung c·∫•p', String(row.nhaCungCap));
        if (row.mucDichDanhGia) p.append('M·ª•c ƒë√≠ch ƒë√°nh gi√°', String(row.mucDichDanhGia));
        if (row.ghiChuYeuCau) p.append('Ghi ch√∫ c·ªßa y√™u c·∫ßu', String(row.ghiChuYeuCau));
        if (row.nguoiYeuCau) p.append('Ng∆∞·ªùi y√™u c·∫ßu', String(row.nguoiYeuCau));
        if (row.emailNguoiYeuCau) p.append('Email ng∆∞·ªùi y√™u c·∫ßu', String(row.emailNguoiYeuCau));
        if (row.emailNguoiNhanTacVu) p.append('Email ng∆∞·ªùi nh·∫≠n t√°c v·ª•', String(row.emailNguoiNhanTacVu));
        if (row.ketQua) p.append('K·∫øt qu·∫£', String(row.ketQua));
        if (row.maBaoCao) p.append('M√£ b√°o c√°o', String(row.maBaoCao));
        if (row.ghiChuBaoCao) p.append('Ghi ch√∫ b√°o c√°o', String(row.ghiChuBaoCao));
        if (row.linkBC || row.reportUrl) p.append('LinkBC', String(row.linkBC || row.reportUrl || ''));
        if (row.nhanXetTruongNhom || row.conclusion) p.append('Nh·∫≠n x√©t tr∆∞·ªüng nh√≥m', String(row.nhanXetTruongNhom || row.conclusion || ''));
        if (row.maPheDuyet) p.append('M√£ ph√™ duy·ªát', String(row.maPheDuyet));
        if (row.nhanXetTruongPhong) p.append('Nh·∫≠n x√©t c·ªßa tr∆∞·ªüng ph√≤ng', String(row.nhanXetTruongPhong));
        if (row.linkKOI) p.append('LinkKOI', String(row.linkKOI));
        if (row.fileDinhKem) p.append('File ƒë√≠nh k√®m', String(row.fileDinhKem));
        if (row.nguoiThucHien || row.reporter) p.append('Ng∆∞·ªùi th·ª±c hi·ªán', String(row.nguoiThucHien || row.reporter || ''));
      }catch(_){ }
    }
      function canonicalStatus(s){
      const v = String(s||'')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,'')
        .toLowerCase();
      if (['pending1','chopheduyet1','cpd1','pending01','pending_1'].includes(v)) return 'pending1';
      if (['pending2','chopheduyet2','cpd2','pending02','pending_2','truongnhomreview'].includes(v)) return 'pending2';
      if (['pending','chopheduyet','cho_duyet','cho'].includes(v)) return 'pending1';
      if (['cancel','canceled','cancelled','huy','huybo','huybo_','dahuy','da_huy','huyyeu_cau','huyyeucau'].includes(v)) return 'cancel';
      if (['doing','inprogress','dang','danglam','dangthuchien','dang_thuc_hien'].includes(v)) return 'doing';
      if (['approved','done','hoanthanh','daduyet','dauyet'].includes(v)) return 'approved';
      if (['changesrequested','dangsua','yeucaubosung','sua'].includes(v)) return 'changesrequested';
      if (['testben','test_ben'].includes(v)) return 'testben';
      if (['rejected','tuchoi'].includes(v)) return 'rejected';
      return v;
    }

    // ===== Employee mapping
    const EMPLOYEE_EMAIL = (()=>{
      const normalize = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
      const raw = {
        "B√πi ƒê·∫∑ng Qu·ªëc Huy":"huy.bui@karofi.vn",
        "ƒê√†o Ho√†ng D∆∞∆°ng":"duong.dao@karofi.vn",
        "ƒê·ªó Quang Long":"long.do@karofi.vn",
        "H√† M·ªπ Linh":"linh.ha@karofi.vn",
        "Nguy·ªÖn H·ªØu Th·ªãnh":"thinh.nguyen2@karofi.vn",
        "Nguy·ªÖn VƒÉn Hi·∫øu":"hieu.nguyen2@karofi.vn",
        "Nguy·ªÖn VƒÉn Linh":"linh.nguyen@karofi.vn",
        "Ph·∫°m Th√†nh Trung Ki√™n":"kien.pham1@karofi.vn",
        "Th√°i Th·ªã Giang":"giang.thai@karofi.vn",
        "Tr·∫ßn Hi·∫øu Nghƒ©a":"nghia.tran@karofi.vn",
        "V≈© Th·ªã H·∫±ng":"hang.vu@karofi.vn",
        "ƒê√†o Tu·∫•n K·ª≥":"ky.dao@karofi.vn",
        "ƒê·ªó Th·∫ø C∆∞·ªùng":"cuong.do@karofi.vn",
        "L·∫°i Qu·ªëc L·ªôc":"loc.lai@karofi.vn",
        "L√™ Ng·ªçc √Ånh":"anh.le1@karofi.vn",
        "L√™ Th·ªã Thanh Nh√†n":"nhan.le@karofi.vn",
        "L√™ Th·ªã Th·∫£o":"thao.le@karofi.vn",
        "L√™ VƒÉn S∆°n":"son.le2@karofi.vn",
        "Nguy·ªÖn Th·ªã Hi·ªÅn":"hien.nguyen1@karofi.vn",
        "Ph·∫°m Th·ªã Minh":"minh.pham1@karofi.vn",
        "V≈© Duy Minh":"minh.vu@karofi.vn",
        "V≈© Th·ªã Thanh Hi·ªÅn":"hien.vu2@karofi.vn"
      };
      const map = {}; Object.keys(raw).forEach(k => map[normalize(k)] = raw[k]);
      return { get: (name)=> map[normalize(name)] || '' };
    })();

    // ===== Data fetching
    async function fetchReports(params){
      const headerMapReports = {
        header_id: 'ID',
        field_id: 'id',
        header_code: 'M√£ b√°o c√°o',
        field_code: 'code',
        header_title: 'Ti√™u ƒë·ªÅ',
        field_title: 'title',
        header_reporter: 'Ng∆∞·ªùi l·∫≠p',
        field_reporter: 'reporter',
        header_reporterEmail: 'Email',
        field_reporterEmail: 'reporterEmail',
        header_submitDate: 'Ng√†y n·ªôp',
        field_submitDate: 'submitDate',
        header_wishDate: 'H·∫°n mong mu·ªën',
        field_wishDate: 'wishDate',
        header_dueDate: 'H·∫°n ƒë√°nh gi√°',
        field_dueDate: 'dueDate',
        header_status: 'Tr·∫°ng th√°i',
        field_status: 'status',
        header_conclusion: 'K·∫øt lu·∫≠n',
        field_conclusion: 'conclusion',
        header_reportUrl: 'Li√™n k·∫øt b√°o c√°o',
        field_reportUrl: 'reportUrl'
      };

      const normalizeDate = (v)=>{ const d=parseDateFlexible(v); if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
      const fromRaw = params && typeof params.from==='string' ? params.from : '';
      const toRaw = params && typeof params.to==='string' ? params.to : '';
      const qRaw = params && typeof params.q==='string' ? params.q : '';
      const statusRaw = params && typeof params.status==='string' ? params.status : '';
      const modeRaw = params && typeof params.mode==='string' ? params.mode : '';
      const pageRaw = params && (params.page!==undefined) ? String(params.page) : '';
      const pageSizeRaw = params && (params.pageSize!==undefined) ? String(params.pageSize) : '';

      const fromIso = normalizeDate(fromRaw);
      const toIso = normalizeDate(toRaw);
      const dateParams = {};
      if (fromIso){ Object.assign(dateParams, { from:fromIso, fromDate:fromIso, date_from:fromIso, start_date:fromIso, submitFrom:fromIso, ngay_tu:fromIso }); }
      if (toIso){ Object.assign(dateParams, { to:toIso, toDate:toIso, date_to:toIso, end_date:toIso, submitTo:toIso, ngay_den:toIso }); }

      const qParams = {};
      if (qRaw){ Object.assign(qParams, { q:qRaw, keyword:qRaw, search:qRaw, s:qRaw, code:qRaw, title:qRaw, reporter:qRaw }); }

      function statusToViLabel(code){
        const m = {
          Pending1:'Ch·ªù ph√™ duy·ªát',
          Pending2:'Tr∆∞·ªüng nh√≥m Review',
          Pending:'Ch·ªù ph√™ duy·ªát',
          Approved:'Done',
          ChangesRequested:'ƒêang s·ª≠a',
          TestBen:'Test b·ªÅn',
          Rejected:'T·ª´ ch·ªëi'
        };
        return m[code] || code;
      }
      const statusParams = {};
      if (statusRaw && statusRaw!=='All'){
        const isPendingGroup = ['Pending','Pending1','Pending2'].includes(String(statusRaw));
        if (!isPendingGroup){
          const labelVi = statusToViLabel(statusRaw);
          Object.assign(statusParams, {
            status: labelVi,
            state: labelVi,
            trangthai: labelVi,
            status_vi: labelVi,
            status_code: statusRaw
          });
        }
      }

      const modeParams = {};
      if (modeRaw && modeRaw!=='All'){
        Object.assign(modeParams, { mode:modeRaw, range:modeRaw, period:modeRaw });
      }

      const pageParams = {};
      const pg = Math.max(1, parseInt(pageRaw||'1', 10)||1);
      const ps = Math.max(1, parseInt(pageSizeRaw||'20', 10)||20);
      const offset = (pg-1)*ps;
      Object.assign(pageParams, { page:String(pg), page_index:String(pg), pageNumber:String(pg), pageSize:String(ps), limit:String(ps), size:String(ps), per_page:String(ps), offset:String(offset) });

      const qs = new URLSearchParams({ action:'reports_query', ...headerMapReports, _ts: Date.now().toString() });
      async function fetchJson(url){ const full=`${url}?${qs.toString()}`; const r = await fetch(full, { method:'GET', cache:'no-store' }); const txt = await r.text(); let parsed=null; try{ parsed=JSON.parse(txt);}catch{} return { ok:r.ok, parsed, raw:txt, status:r.status, fullUrl:full }; }
      async function postJson(url, params){ const body = new URLSearchParams(params||{}); const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: body.toString(), cache:'no-store' }); const txt = await r.text(); let parsed=null; try{ parsed=JSON.parse(txt);}catch{} return { ok:r.ok, parsed, raw:txt, status:r.status, fullUrl:url+' [POST]' }; }
      async function fetchJsonMinimal(url){
        const qs2 = new URLSearchParams({ action:'reports_query', ...headerMapReports, _ts: Date.now().toString() });
        const full=`${url}?${qs2.toString()}`; const r=await fetch(full,{method:'GET'}); const txt=await r.text(); let parsed=null; try{ parsed=JSON.parse(txt);}catch{} return { ok:r.ok, parsed, raw:txt, status:r.status, fullUrl:full };
      }
      function safeParse(txt){ try{ return JSON.parse(txt); }catch(_){ return null; } }
      function collectRowsDeep(json){
        if(!json) return [];
        if(Array.isArray(json)) return json;
        const out=[]; const seen=new Set(); const q=[json];
        try{
          while(q.length){
            const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
            for(const v of Object.values(cur)){
              if(Array.isArray(v)){
                if(v.length && typeof v[0]==='object') out.push(...v);
                v.forEach(x=>{ if(x && typeof x==='object') q.push(x); });
                continue;
              }
              if(typeof v==='string'){
                const j = safeParse(v); if(j){ q.push(j); continue; }
              }
              if(v && typeof v==='object') q.push(v);
            }
          }
        }catch(_){ }
        return out.length? out: (typeof json==='object'? [json]: []);
      }
      let resp = await fetchJson(REPORTS_QUERY_URL);
      try{ console.log('[Reports] URL:', resp.fullUrl, 'status:', resp.status); }catch(_){ }
      if (!resp.ok || /could not be started/i.test(String(resp.parsed?.message||''))){
        resp = await fetchJson(REPORTS_QUERY_URL.replace('/webhook-test/','/webhook/'));
      }
      if ((!resp.ok || !resp.raw || !String(resp.raw).trim()) && REPORTS_QUERY_URL.includes('/webhook/')){
        const alt = REPORTS_QUERY_URL.replace('/webhook/','/webhook-test/');
        if (alt !== REPORTS_QUERY_URL){
          try{ console.warn('[Reports] Retry with webhook-test variant'); }catch(_){ }
          resp = await fetchJson(alt);
        }
      }
      if (resp.ok && (!resp.raw || !String(resp.raw).trim())){
        try{ console.warn('[Reports] Empty body, retry with minimal params'); }catch(_){ }
        resp = await fetchJsonMinimal(REPORTS_QUERY_URL);
        if ((!resp.ok || !resp.raw || !String(resp.raw).trim()) && REPORTS_QUERY_URL.includes('/webhook/')){
          const alt = REPORTS_QUERY_URL.replace('/webhook/','/webhook-test/');
          if (alt !== REPORTS_QUERY_URL){
            try{ console.warn('[Reports] Minimal retry with webhook-test variant'); }catch(_){ }
            resp = await fetchJsonMinimal(alt);
          }
        }
      }
      if (!resp.ok) return [];
      if (resp.ok && (!resp.raw || !String(resp.raw).trim())){
        try{ console.warn('[Reports] Empty body on GET, retry with POST'); }catch(_){ }
        const postParams = { action:'reports_query', ...Object.fromEntries(qs.entries()) };
        delete postParams._ts;
        resp = await postJson(REPORTS_QUERY_URL, { ...postParams, _ts: Date.now().toString() });
      }
      if (resp.ok && (!resp.raw || !String(resp.raw).trim())){
        const minimal = { action:'reports_query', ...headerMapReports, _ts: Date.now().toString() };
        resp = await postJson(REPORTS_QUERY_URL, minimal);
      }
      const baseJson = resp.parsed ?? safeParse(resp.raw);
      const rows = collectRowsDeep(baseJson);
      try{ console.log('[Reports] rows.length =', rows?.length||0); }catch(_){ }
      function normalizeStatus(val){
        const v = String(val||'').trim().toLowerCase();
        const v2 = v.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'');
        if (!v) return 'Pending1';
        if ([
          'pending1','pending 1','cho phe duyet 1','ch·ªù ph√™ duy·ªát 1','cho_phe_duyet_1','cho duyet 1','chopheduyet1','cpd1'
        ].includes(v)) return 'Pending1';
        if ([
          'pending2','pending 2','cho phe duyet 2','ch·ªù ph√™ duy·ªát 2','cho_phe_duyet_2','cho duyet 2','chopheduyet2','cpd2'
        ].includes(v) || v2==='truongnhomreview' || v.includes('tr∆∞·ªüng nh√≥m review') || v.includes('truong nhom review')) return 'Pending2';
        if (['pending','cho phe duyet','ch·ªù ph√™ duy·ªát','cho_duyet','cho'].includes(v)) return 'Pending1';
        if (['approved','done','hoan thanh','ho√†n th√†nh','da duyet','ƒë√£ duy·ªát'].includes(v)) return 'Approved';
        if (['changesrequested','dang sua','ƒëang s·ª≠a','yeu cau bo sung','y√™u c·∫ßu b·ªï sung','sua'].includes(v)) return 'ChangesRequested';
        if (['test ben','test_ben','testben'].includes(v)) return 'TestBen';
        if (['rejected','tu choi','t·ª´ ch·ªëi'].includes(v)) return 'Rejected';
        return val;
      }
      function lowerKeyMap(obj){
        const map={};
        try{ Object.keys(obj||{}).forEach(k=>{ map[String(k).toLowerCase()] = obj[k]; }); }catch(_){ }
        return map;
      }
      function getFrom(lowerObj, ...keys){
        for(const k of keys){
          const kk = String(k||'').toLowerCase();
          if (lowerObj.hasOwnProperty(kk)) return lowerObj[kk];
        }
        return '';
      }
      const normalizedRows = rows.map(x=>{
        const lx = lowerKeyMap(x||{});
        // Map t·ª´ c·∫•u tr√∫c JSON m·ªõi
        const id = getFrom(lx,'id','ID','reportId','report_id');
        const code = getFrom(lx,'m√£ t√°c v·ª•','code','m√£ b√°o c√°o','ma','taskcode','reportCode');
        const title = getFrom(lx,'t√™n t√°c v·ª•','title','ti√™u ƒë·ªÅ','name','reportTitle','t√™n');
        const reporter = getFrom(lx,'ng∆∞·ªùi th·ª±c hi·ªán','reporter','ng∆∞·ªùi l·∫≠p','employee','author','nh√¢n vi√™n');
        const reporterEmail = getFrom(lx,'reporterEmail','email');
        const submitDate = getFrom(lx,'ng√†y ho√†n th√†nh th·ª±c t·∫ø');
        const wishDate = getFrom(lx,'h·∫°n mong mu·ªën c·ªßa c√°c b√™n','wishDate','h·∫°n mong mu·ªën','hanmongmuon','wish');
        const dueDate = getFrom(lx,'dueDate','deadline','h·∫°n ƒë√°nh gi√°','ng√†y ho√†n th√†nh th·ª±c t·∫ø');

        // C√°c tr∆∞·ªùng theo ƒë√∫ng json.json
        const ngayYeuCauCacBen = getFrom(lx,'ng√†y y√™u c·∫ßu c·ªßa c√°c b√™n');
        const hanMongMuonCacBen = getFrom(lx,'h·∫°n mong mu·ªën c·ªßa c√°c b√™n');
        const ngayBatDauThucTe = getFrom(lx,'ng√†y b·∫Øt ƒë·∫ßu th·ª±c t·∫ø');
        const ngayHoanThanhThucTe = getFrom(lx,'ng√†y ho√†n th√†nh th·ª±c t·∫ø');
        const maTacVu = getFrom(lx,'m√£ t√°c v·ª•');
        const tenTacVu = getFrom(lx,'t√™n t√°c v·ª•');
        const nhaCungCap = getFrom(lx,'nh√† cung c·∫•p');
        const mucDichDanhGia = getFrom(lx,'m·ª•c ƒë√≠ch ƒë√°nh gi√°');
        const ghiChuYeuCau = getFrom(lx,'ghi ch√∫ c·ªßa y√™u c·∫ßu');
        const nguoiYeuCau = getFrom(lx,'ng∆∞·ªùi y√™u c·∫ßu');
        const emailNguoiYeuCau = getFrom(lx,'email ng∆∞·ªùi y√™u c·∫ßu');
        const emailNguoiNhanTacVu = getFrom(lx,'email ng∆∞·ªùi nh·∫≠n t√°c v·ª•');
        const ketQua = getFrom(lx,'k·∫øt qu·∫£');
        const maBaoCao = getFrom(lx,'m√£ b√°o c√°o');
        const ghiChuBaoCao = getFrom(lx,'ghi ch√∫ b√°o c√°o');
        const linkBC = getFrom(lx,'linkbc');
        const nhanXetTruongNhom = getFrom(lx,'nh·∫≠n x√©t tr∆∞·ªüng nh√≥m');
        const maPheDuyet = getFrom(lx,'m√£ ph√™ duy·ªát');
        const nhanXetTruongPhong = getFrom(lx,'nh·∫≠n x√©t c·ªßa tr∆∞·ªüng ph√≤ng');
        const linkKOI = getFrom(lx,'linkkoi');
        const fileDinhKem = getFrom(lx,'file ƒë√≠nh k√®m');
        const nguoiThucHien = getFrom(lx,'ng∆∞·ªùi th·ª±c hi·ªán');

        const statusRaw = getFrom(lx,'k·∫øt qu·∫£','status','tr·∫°ng th√°i','trangthai');
        const conclusion = getFrom(lx,'nh·∫≠n x√©t tr∆∞·ªüng nh√≥m','conclusion','k·∫øt lu·∫≠n','ketluan','ghi ch√∫ b√°o c√°o');
        const reportUrl = getFrom(lx,'linkbc','reportUrl','li√™n k·∫øt b√°o c√°o','url','link','href');
        const reportCode = getFrom(lx,'m√£ b√°o c√°o');
        return {
          id: id || code || '',
          code: code || id || reportCode || '',
          title: title || '',
          reporter: reporter || '',
          reporterEmail: reporterEmail || '',
          submitDate: submitDate || '',
          wishDate: wishDate || '',
          dueDate: dueDate || '',
          status: (function(){
            const s = String(statusRaw||'').trim().toLowerCase();
            // Map c√°c tr·∫°ng th√°i t·ª´ JSON m·ªõi
            if (s === 'done') return 'Approved';
            if (s === 'doing') return 'Pending1';
            if (s.includes('tr∆∞·ªüng nh√≥m review') || s.includes('truong nhom review')) return 'Pending2';
            if (s.includes('ch·ªù ph√™ duy·ªát 1') || s.includes('cho phe duyet 1')) return 'Pending1';
            if (s.includes('ch·ªù ph√™ duy·ªát 2') || s.includes('cho phe duyet 2')) return 'Pending2';
            return normalizeStatus(statusRaw || 'Pending1');
          })(),
          conclusion: conclusion || '',
          reportUrl: reportUrl || '',

          // Gi·ªØ to√†n b·ªô d·ªØ li·ªáu g·ªëc (theo json.json) ƒë·ªÉ g·ª≠i l·∫°i khi action
          ngayYeuCauCacBen: ngayYeuCauCacBen || '',
          hanMongMuonCacBen: hanMongMuonCacBen || '',
          ngayBatDauThucTe: ngayBatDauThucTe || '',
          ngayHoanThanhThucTe: ngayHoanThanhThucTe || '',
          maTacVu: maTacVu || code || '',
          tenTacVu: tenTacVu || title || '',
          nhaCungCap: nhaCungCap || '',
          mucDichDanhGia: mucDichDanhGia || '',
          ghiChuYeuCau: ghiChuYeuCau || '',
          nguoiYeuCau: nguoiYeuCau || '',
          emailNguoiYeuCau: emailNguoiYeuCau || '',
          emailNguoiNhanTacVu: emailNguoiNhanTacVu || '',
          ketQua: ketQua || String(statusRaw||'') || '',
          maBaoCao: maBaoCao || reportCode || '',
          ghiChuBaoCao: ghiChuBaoCao || '',
          linkBC: linkBC || reportUrl || '',
          nhanXetTruongNhom: nhanXetTruongNhom || conclusion || '',
          maPheDuyet: maPheDuyet || '',
          nhanXetTruongPhong: nhanXetTruongPhong || '',
          linkKOI: linkKOI || '',
          fileDinhKem: fileDinhKem || '',
          nguoiThucHien: nguoiThucHien || reporter || ''
        };
      });
      const isMeaningful = (r)=>{
        const hasId = String(r?.id||'').trim().length>0;
        const hasMain = ['code','title','reporter','reportUrl'].some(k=> String(r?.[k]||'').trim().length>0);
        return hasId || hasMain;
      };
      const seenKeys = new Set();
      const cleanedRows = normalizedRows.filter(r=>{
        if (!isMeaningful(r)) return false;
        const key = [r.id,r.code,r.title,r.reporter,r.submitDate,r.reportUrl].map(x=> String(x||'').trim().toLowerCase()).join('|');
        if (seenKeys.has(key)) return false; seenKeys.add(key); return true;
      });
      try{
        const statusCounts = (cleanedRows||[]).reduce((acc, it)=>{
          const k = String(it?.status||'').toLowerCase(); acc[k] = (acc[k]||0)+1; return acc;
        }, {});
        console.log('[Reports] status counts =', statusCounts);
      }catch(_){ }
      return cleanedRows;
    }

    // ===== Render
    function applyFilters(all){
      const q = (document.getElementById('flt-q')?.value || '').trim().toLowerCase();
      const st = (document.getElementById('flt-status')?.value || 'All');
      const from = parseDateFlexible(document.getElementById('flt-from')?.value || '');
      const to   = parseDateFlexible(document.getElementById('flt-to')?.value || '');
      const out = all.filter(it=>{
        const okQ = !q || [it.code,it.title,it.reporter].join(' ').toLowerCase().includes(q);
        const canon = canonicalStatus(it.status);
        const okAllPrune = (st==='All') ? (!['cancel','doing'].includes(canon)) : true;
        const okS = (st==='All') || (canon===canonicalStatus(st));
        const okG = isInGroup(it.reporter, SELECTED_GROUP);
        let okD = true;
        const sub = parseDateFlexible(it.submitDate);
        if (!['pending1','pending2'].includes(canon)){
          if (from && sub) okD = okD && (sub.getTime() >= new Date(from.getFullYear(),from.getMonth(),from.getDate()).getTime());
          if (to && sub) okD = okD && (sub.getTime() <= new Date(to.getFullYear(),to.getMonth(),to.getDate(),23,59,59,999).getTime());
        }
        return okQ && okS && okG && okD && okAllPrune;
      });
      out.sort((a,b)=>{
        const pa = ['pending1','pending2'].includes(canonicalStatus(a.status)) ? 0 : 1;
        const pb = ['pending1','pending2'].includes(canonicalStatus(b.status)) ? 0 : 1;
        if (pa!==pb) return pa-pb;
        const ta = parseDateFlexible(a.submitDate)?.getTime()||0;
        const tb = parseDateFlexible(b.submitDate)?.getTime()||0;
        return tb - ta;
      });
      return out;
    }

    function updatePager(total){
      const pager = document.getElementById('pager');
      const info = document.getElementById('page-info');
      const ps = PAGE_SIZE; const pages = Math.max(1, Math.ceil(total/ps));
      if (CURRENT_PAGE > pages) CURRENT_PAGE = pages;
      if (info) info.textContent = `Trang ${CURRENT_PAGE}/${pages} (${total} d√≤ng)`;
      pager.style.display = total>0 ? 'flex' : 'none';
    }

    function renderTable(){
      const body = document.getElementById('list-body'); if (!body) return;
      try{ console.log('[Render] FILTERED length =', FILTERED?.length||0, 'group=', SELECTED_GROUP); }catch(_){ }
      const total = FILTERED.length; updatePager(total);
      if (!total){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'; return; }
      const start = (CURRENT_PAGE-1)*PAGE_SIZE; const end = Math.min(total, start+PAGE_SIZE);
      const pageItems = FILTERED.slice(start,end);
      const today = new Date(); const today0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
      body.innerHTML = pageItems.map(it=>{
        const due = parseDateFlexible(it.dueDate);
        let trClass = '';
        if (due){
          const d0 = new Date(due.getFullYear(),due.getMonth(),due.getDate());
          if (d0.getTime() === today0.getTime()) trClass = 'bg-yellow-50';
          else if (d0.getTime() < today0.getTime()) trClass = 'bg-red-50';
        }
        const statusBadge = ({
          'Pending1': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-rose-50 text-rose-700 border border-rose-200">Ch·ªù ph√™ duy·ªát</span>',
          'Pending2': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-rose-50 text-rose-700 border border-rose-200">Tr∆∞·ªüng nh√≥m Review</span>',
          'Approved': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-rose-100 text-rose-800 border border-rose-200">Done</span>',
          'ChangesRequested': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-rose-50 text-rose-700 border border-rose-200">ƒêang s·ª≠a</span>',
          'TestBen': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-rose-50 text-rose-700 border border-rose-200">Test b·ªÅn</span>',
          'Rejected': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-rose-50 text-rose-700 border border-rose-200">T·ª´ ch·ªëi</span>'
        })[String(it.status||'Pending1')] || String(it.status||'');
        const canApprove = String(it.status||'')==='Pending2';
        const canOther = ['Pending1','Pending2'].includes(String(it.status||''));
        (function(){})();
        const _secEl = document.getElementById('secret-code');
        const _secRaw = String((_secEl||{}).value||'');
        const _secNorm = _secRaw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase();
        const hasCode = ['vietvip'].includes(_secNorm);
        const disApprove = (canApprove && hasCode) ? '' : 'opacity-50 pointer-events-none';
        const disOther = canOther ? '' : 'opacity-50 pointer-events-none';
        return `
          <tr class="${trClass}">
            <td class="px-3 py-2"><a href="#" class="text-blue-700 underline report-link" data-id="${it.id}">${it.code}</a></td>
            <td class="px-3 py-2"><a href="#" class="text-blue-700 hover:underline task-detail-link" data-id="${it.id}">${it.title}</a></td>
            <td class="px-3 py-2"><div>${it.reporter}</div>${it.reporterEmail?`<div class=\"text-xs text-gray-500\">${it.reporterEmail}</div>`:''}</td>
            <td class="px-3 py-2">${fmtDmy(it.submitDate)}</td>
            <td class="px-3 py-2">${fmtDmy(it.wishDate)}</td>
            <td class="px-3 py-2">${fmtDmy(it.dueDate)}</td>
            <td class="px-3 py-2">${statusBadge}</td>
            <td class="px-3 py-2">${it.conclusion?String(it.conclusion):''}</td>
            <td class="px-3 py-2">
              <div class="flex items-center gap-2">
                <button class="px-3 py-1 rounded-full text-white font-semibold bg-primary-blue hover:brightness-105 act-approve ${disApprove}" data-id="${it.id}">Duy·ªát</button>
                <button class="px-3 py-1 rounded-full text-white font-semibold act-reject ${disOther}" style="background:#ef4444" data-id="${it.id}">T·ª´ ch·ªëi</button>
                <button class="px-3 py-1 rounded-full text-white font-semibold act-request ${disOther}" style="background:#f59e0b" data-id="${it.id}">Y√™u c·∫ßu b·ªï sung</button>
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    // ===== Actions
    function findItem(id){ return ALL_ITEMS.find(x=> String(x.id)===String(id)); }

    async function openTaskDetail(id){
      const modalId='modal-task'; const titleEl=document.getElementById('task-title'); const content=document.getElementById('task-content'); const openNew=document.getElementById('task-open-new');
      const it=findItem(id); if(titleEl) titleEl.textContent = it? `${it.code} ‚Äî ${it.title}` : String(id||'');
      if(content) content.textContent='ƒêang t·∫£i...';
      let url=''; let detailHtml='';

      const headerMapDetail = {
        header_id:'ID', field_id:'id', header_code:'M√£', field_code:'code', header_title:'T√™n t√°c v·ª•', field_title:'title',
        header_requester:'Ng∆∞·ªùi y√™u c·∫ßu', field_requester:'requesterName', header_requesterDept:'Ph√≤ng ban y√™u c·∫ßu', field_requesterDept:'requesterDept', header_receiver:'Ng∆∞·ªùi nh·∫≠n m·∫´u', field_receiver:'receiverName',
        header_form:'Form ƒë√°nh gi√°', field_form:'formName', header_manhour:'C√¥ng chu·∫©n', field_manhour:'manhour',
        header_requestDate:'Ng√†y y√™u c·∫ßu', field_requestDate:'requestDate', header_wishDate:'H·∫°n mong mu·ªën', field_wishDate:'wishDate',
        header_purpose:'M·ª•c ƒë√≠ch ƒë√°nh gi√°', field_purpose:'purpose', header_note:'Note', field_note:'note', header_special:'Y√™u c·∫ßu test ƒë·∫∑c bi·ªát', field_special:'specialTest',
        header_link:'Link', field_link:'link'
      };
      const qs=new URLSearchParams({ action:'task_detail', ...headerMapDetail, id:String(id), _ts:Date.now().toString() });
      async function fetchJson(u){ const r=await fetch(`${u}?${qs.toString()}`, { method:'GET' }); const t=await r.text(); let j=null; try{ j=JSON.parse(t);}catch{} return { ok:r.ok, parsed:j, raw:t, status:r.status }; }
      function pickObj(j){ if(!j) return null; if(Array.isArray(j) && j.length) return j[0]; if(typeof j==='object') return j; try{ const q=[j]; const seen=new Set(); while(q.length){ const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); if(Object.keys(cur).length) return cur; for(const v of Object.values(cur)){ if(v && typeof v==='object') q.push(v); } } }catch(_){ } return null; }
      let resp=await fetchJson(WEBHOOK_TEST); if(!resp.ok || /could not be started/i.test(String(resp.parsed?.message||''))) resp=await fetchJson(WEBHOOK_PROD);
      const obj=pickObj(resp.parsed ?? (resp.raw? JSON.parse(resp.raw): null)) || {};
      const get=(...keys)=>{ for(const k of keys){ const v=obj[k]||obj[k?.toLowerCase?.()]; if(v!==undefined) return v; } return ''; };
      url = get('link','url','href')||'';
      detailHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
        <div><b>M√£:</b> ${get('code','ma','id')}</div>
        <div><b>T√™n t√°c v·ª•:</b> ${get('title','name')}</div>
        <div><b>Ng∆∞·ªùi y√™u c·∫ßu:</b> ${get('requesterName','requester','nguoiyc')}</div>
        <div><b>Ph√≤ng ban y√™u c·∫ßu:</b> ${get('requesterDept','dept','phongban')}</div>
        <div><b>Ng∆∞·ªùi nh·∫≠n m·∫´u:</b> ${get('receiverName','receiver','nguoinhan')}</div>
        <div><b>Form ƒë√°nh gi√°:</b> ${get('formName','form')}</div>
        <div><b>C√¥ng chu·∫©n:</b> ${get('manhour','congchuan')}</div>
        <div><b>Ng√†y y√™u c·∫ßu:</b> ${fmtDmy(get('requestDate','ngayyeucau','ngay_yeu_cau'))}</div>
        <div><b>H·∫°n mong mu·ªën:</b> ${fmtDmy(get('wishDate','wish'))}</div>
        <div class="md:col-span-2"><b>M·ª•c ƒë√≠ch ƒë√°nh gi√°:</b> ${get('purpose','mucdich')}</div>
        <div class="md:col-span-2"><b>Note:</b> ${get('note')}</div>
        <div class="md:col-span-2"><b>Y√™u c·∫ßu test ƒë·∫∑c bi·ªát:</b> ${get('specialTest','yeucautest')}</div>
      </div>`;

      if (openNew){ openNew.href = url||'#'; openNew.style.pointerEvents = url? '':'none'; openNew.style.opacity = url? '1':'0.5'; }
      if (content) content.innerHTML = detailHtml;
      openModal(modalId);
    }

    async function openReportPreview(id){
      const modalId = 'modal-report'; const frame = document.getElementById('report-frame'); const titleEl = document.getElementById('report-title'); const openNew = document.getElementById('report-open-new');
      const it = findItem(id); if (titleEl) titleEl.textContent = it ? `${it.code} ‚Äî ${it.title}` : String(id||'');
      let url = '';
      {
        const it = findItem(id);
        url = it?.reportUrl || '';
        if (!url){
          const headerMapDetail = { header_reportUrl: 'Li√™n k·∫øt b√°o c√°o', field_reportUrl: 'reportUrl' };
          const qs = new URLSearchParams({ action:'report_detail', ...headerMapDetail, id:String(id), _ts: Date.now().toString() });
          async function fetchJson(u){ const r=await fetch(`${u}?${qs.toString()}`, { method:'GET' }); const t=await r.text(); let j=null; try{ j=JSON.parse(t);}catch{} return { ok:r.ok, parsed:j, raw:t, status:r.status }; }
          function pickUrl(j){ if(!j) return ''; const cands=['url','reportUrl','link','file','href']; for(const k of cands){ const v=j[k]||j[k.toLowerCase?.()]||undefined; if (typeof v==='string' && v) return v; } try{ const q=[j]; const seen=new Set(); while(q.length){ const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const [k,v] of Object.entries(cur)){ if (typeof v==='string' && /https?:\/\//i.test(v)) return v; if (v && typeof v==='object') q.push(v); } } }catch(_){} return ''; }
          let resp = await fetchJson(WEBHOOK_TEST);
          if (!resp.ok || /could not be started/i.test(String(resp.parsed?.message||''))) resp = await fetchJson(WEBHOOK_PROD);
          url = pickUrl(resp.parsed ?? (resp.raw? JSON.parse(resp.raw): null)) || '';
        }
      }
      if (openNew) { openNew.href = url || '#'; openNew.style.pointerEvents = url ? '' : 'none'; openNew.style.opacity = url ? '1' : '0.5'; }
      if (frame) frame.src = url || 'about:blank';
      openModal(modalId);
    }

    async function doApprove(){
      const btn = document.getElementById('approve-do'); if (!CURRENT_ITEM_ID || !btn) return;
      const prev = btn.textContent; btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
      const comment = (document.getElementById('approve-comment')?.value||'').trim();
      const qaCode = generateQaPdCode();
      try{
          function normCode(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase(); }
          const codeInput = normCode(document.getElementById('secret-code')?.value||'');
          if (!codeInput){ throw new Error('Vui l√≤ng nh·∫≠p m√£ b·∫£o m·∫≠t tr∆∞·ªõc khi duy·ªát.'); }
          const CODE_TO_NAME = { 'vietvip':'Nguy·ªÖn Th·∫ø Vi·ªát' };
          const reviewer = codeInput;
          const p = new URLSearchParams({ action:'report_approve', id:String(CURRENT_ITEM_ID), reviewer, _ts: Date.now().toString() });
          try{ 
            const it = findItem(CURRENT_ITEM_ID); 
            const overrides = {
              nhanXetTruongNhom: comment || '',
              maPheDuyet: qaCode,
              ketQua: 'Tr∆∞·ªüng nh√≥m Review'
            };
            appendRowParams(p, it, overrides); 
          }catch(_){ }
          async function tryPost(url){ try{ const r=await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p.toString(), cache:'no-store' }); const t=await r.text(); return { ok:r.ok, raw:t }; }catch(err){ return { ok:false, raw:String(err||'') }; } }
          let r = await tryPost(FORM_ACTION_URL);
          if (!r.ok) r = await tryPost(FORM_ACTION_URL);
          if (!r.ok) throw new Error(r.raw||'G·ª≠i th·∫•t b·∫°i');
        closeModal('modal-approve'); showToast(`ƒê√£ duy·ªát b√°o c√°o. M√£: ${qaCode}`,'success');
        await reload();
      }catch(err){ showToast('L·ªói duy·ªát b√°o c√°o.','error'); }
      finally{ btn.disabled=false; btn.textContent = prev||'X√°c nh·∫≠n duy·ªát'; }
    }

    async function doReject(){
      const btn = document.getElementById('reject-do'); if (!CURRENT_ITEM_ID || !btn) return;
      const prev = btn.textContent; btn.disabled=true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
      const reason = (document.getElementById('reject-reason')?.value||'').trim();
      if (!reason){ showToast('Vui l√≤ng nh·∫≠p l√Ω do.','error'); btn.disabled=false; btn.textContent=prev; return; }
          const qaCode = generateQaPdCode();
          try{
          const p = new URLSearchParams({ action:'report_reject', id:String(CURRENT_ITEM_ID), reviewer: (document.getElementById('secret-code')?.value||'').trim(), _ts: Date.now().toString() });
          try{ 
            const it = findItem(CURRENT_ITEM_ID); 
            const overrides = {
              nhanXetTruongNhom: reason || '',
              maPheDuyet: qaCode,
              ketQua: 'Rejected'
            };
            appendRowParams(p, it, overrides); 
          }catch(_){ }
          async function tryPost(url){ try{ const r=await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p.toString(), cache:'no-store' }); const t=await r.text(); return { ok:r.ok, raw:t }; }catch(err){ return { ok:false, raw:String(err||'') }; } }
          let r = await tryPost(FORM_ACTION_URL);
          if (!r.ok) r = await tryPost(FORM_ACTION_URL);
          if (!r.ok) throw new Error(r.raw||'G·ª≠i th·∫•t b·∫°i');
        closeModal('modal-reject'); showToast(`ƒê√£ t·ª´ ch·ªëi. M√£: ${qaCode}`,'success');
        await reload();
      }catch(err){ showToast('L·ªói t·ª´ ch·ªëi.','error'); }
      finally{ btn.disabled=false; btn.textContent = prev||'X√°c nh·∫≠n t·ª´ ch·ªëi'; }
    }

    async function doRequest(){
      const btn = document.getElementById('req-do'); if (!CURRENT_ITEM_ID || !btn) return;
      const prev = btn.textContent; btn.disabled=true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
      const comment = (document.getElementById('req-comment')?.value||'').trim();
      const dueDate = (document.getElementById('req-due')?.value||'').trim();
          const qaCode = generateQaPdCode();
          try{
          const p = new URLSearchParams({ action:'report_request_changes', id:String(CURRENT_ITEM_ID), reviewer: (document.getElementById('secret-code')?.value||'').trim(), _ts: Date.now().toString() });
          try{ 
            const it = findItem(CURRENT_ITEM_ID); 
            const overrides = {
              nhanXetTruongNhom: comment || '',
              maPheDuyet: qaCode,
              ketQua: 'ChangesRequested',
              hanMongMuonCacBen: dueDate || it.hanMongMuonCacBen || ''
            };
            appendRowParams(p, it, overrides); 
          }catch(_){ }
          async function tryPost(url){ try{ const r=await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p.toString(), cache:'no-store' }); const t=await r.text(); return { ok:r.ok, raw:t }; }catch(err){ return { ok:false, raw:String(err||'') }; } }
          let r = await tryPost(FORM_ACTION_URL);
          if (!r.ok) r = await tryPost(FORM_ACTION_URL);
          if (!r.ok) throw new Error(r.raw||'G·ª≠i th·∫•t b·∫°i');
        closeModal('modal-req'); showToast(`ƒê√£ y√™u c·∫ßu b·ªï sung. M√£: ${qaCode}`,'success');
        await reload();
      }catch(err){ showToast('L·ªói g·ª≠i y√™u c·∫ßu.','error'); }
      finally{ btn.disabled=false; btn.textContent = prev||'G·ª≠i y√™u c·∫ßu'; }
    }

    // ===== Statistics
    let chartStatus = null;
    let chartReporter = null;

    function calculateStatistics(items, groupFilter = 'all', fromDate = null, toDate = null){
      let filtered = items.filter(it => {
        if (!isInGroup(it.reporter, groupFilter)) return false;
        if (fromDate || toDate) {
          const sub = parseDateFlexible(it.submitDate);
          if (sub) {
            if (fromDate && sub.getTime() < new Date(fromDate.getFullYear(), fromDate.getMonth(), fromDate.getDate()).getTime()) return false;
            if (toDate && sub.getTime() > new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate(), 23, 59, 59, 999).getTime()) return false;
          }
        }
        return true;
      });

      const stats = {
        total: filtered.length,
        pending: 0,
        approved: 0,
        changes: 0,
        rejected: 0,
        testben: 0,
        byStatus: {},
        byReporter: {}
      };

      filtered.forEach(it => {
        const status = canonicalStatus(it.status);
        stats.byStatus[status] = (stats.byStatus[status] || 0) + 1;
        
        if (status === 'pending1' || status === 'pending2') stats.pending++;
        else if (status === 'approved') stats.approved++;
        else if (status === 'changesrequested') stats.changes++;
        else if (status === 'rejected') stats.rejected++;
        else if (status === 'testben') stats.testben++;

        const reporter = it.reporter || 'Kh√¥ng x√°c ƒë·ªãnh';
        if (!stats.byReporter[reporter]) {
          stats.byReporter[reporter] = {
            total: 0,
            pending: 0,
            approved: 0,
            changes: 0,
            rejected: 0
          };
        }
        stats.byReporter[reporter].total++;
        if (status === 'pending1' || status === 'pending2') stats.byReporter[reporter].pending++;
        else if (status === 'approved') stats.byReporter[reporter].approved++;
        else if (status === 'changesrequested') stats.byReporter[reporter].changes++;
        else if (status === 'rejected') stats.byReporter[reporter].rejected++;
      });

      return stats;
    }

    function updateStatisticsDisplay(stats){
      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-pending').textContent = stats.pending;
      document.getElementById('stat-approved').textContent = stats.approved;
      document.getElementById('stat-changes').textContent = stats.changes;

      // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì tr·∫°ng th√°i
      const statusLabels = {
        'pending1': 'Ch·ªù ph√™ duy·ªát 1',
        'pending2': 'Tr∆∞·ªüng nh√≥m Review',
        'approved': 'ƒê√£ duy·ªát',
        'changesrequested': 'ƒêang s·ª≠a',
        'rejected': 'T·ª´ ch·ªëi',
        'testben': 'Test b·ªÅn'
      };

      const statusData = [];
      const statusColors = {
        'pending1': '#fda4af',
        'pending2': '#ec4899',
        'approved': '#10b981',
        'changesrequested': '#f59e0b',
        'rejected': '#ef4444',
        'testben': '#8b5cf6'
      };

      const labels = [];
      const data = [];
      const colors = [];

      Object.keys(statusLabels).forEach(key => {
        if (stats.byStatus[key] > 0) {
          labels.push(statusLabels[key]);
          data.push(stats.byStatus[key]);
          colors.push(statusColors[key] || '#94a3b8');
        }
      });

      const ctxStatus = document.getElementById('chart-status');
      if (ctxStatus) {
        if (chartStatus) chartStatus.destroy();
        chartStatus = new Chart(ctxStatus, {
          type: 'doughnut',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: colors,
              borderWidth: 2,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                position: 'bottom'
              }
            }
          }
        });
      }

      // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì theo ng∆∞·ªùi l·∫≠p (top 10)
      const reporters = Object.entries(stats.byReporter)
        .sort((a, b) => b[1].total - a[1].total)
        .slice(0, 10);

      const reporterLabels = reporters.map(r => r[0]);
      const reporterData = reporters.map(r => r[1].total);
      const reporterColors = Array.from({length: reporters.length}, (_, i) => {
        const hues = ['#ec4899', '#f472b6', '#fda4af', '#fecdd3', '#f9a8d4'];
        return hues[i % hues.length];
      });

      const ctxReporter = document.getElementById('chart-reporter');
      if (ctxReporter) {
        if (chartReporter) chartReporter.destroy();
        chartReporter = new Chart(ctxReporter, {
          type: 'bar',
          data: {
            labels: reporterLabels,
            datasets: [{
              label: 'S·ªë l∆∞·ª£ng b√°o c√°o',
              data: reporterData,
              backgroundColor: reporterColors,
              borderColor: '#ec4899',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }

      // C·∫≠p nh·∫≠t b·∫£ng th·ªëng k√™
      const tbody = document.getElementById('stats-table-body');
      if (tbody) {
        const sortedReporters = Object.entries(stats.byReporter)
          .sort((a, b) => b[1].total - a[1].total);
        
        if (sortedReporters.length === 0) {
          tbody.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="6">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        } else {
          tbody.innerHTML = sortedReporters.map(([reporter, data]) => `
            <tr>
              <td class="px-3 py-2 font-medium">${reporter}</td>
              <td class="px-3 py-2 text-center">${data.total}</td>
              <td class="px-3 py-2 text-center">${data.pending}</td>
              <td class="px-3 py-2 text-center">${data.approved}</td>
              <td class="px-3 py-2 text-center">${data.changes}</td>
              <td class="px-3 py-2 text-center">${data.rejected}</td>
            </tr>
          `).join('');
        }
      }
    }

    function loadStatistics(){
      if (!ALL_ITEMS || ALL_ITEMS.length === 0) {
        showToast('Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc', 'error');
        return;
      }
      const group = document.getElementById('stats-group')?.value || 'all';
      const fromRaw = document.getElementById('stats-from')?.value || '';
      const toRaw = document.getElementById('stats-to')?.value || '';
      const fromDate = fromRaw ? parseDateFlexible(fromRaw) : null;
      const toDate = toRaw ? parseDateFlexible(toRaw) : null;
      
      const stats = calculateStatistics(ALL_ITEMS, group, fromDate, toDate);
      updateStatisticsDisplay(stats);
    }

    // ===== Assign Functions
    async function fetchAssignData(){
      try{
        const qs = new URLSearchParams({ action:'assign_query', _ts: Date.now().toString() });
        const url = `${ASSIGN_QUERY_URL}?${qs.toString()}`;
        const r = await fetch(url, { method:'GET', cache:'no-store' });
        const txt = await r.text();
        let parsed = null;
        try{ parsed = JSON.parse(txt); }catch(_){ }
        
        if (!r.ok) return [];
        
        function collectRowsDeep(json){
          if(!json) return [];
          if(Array.isArray(json)) return json;
          const out=[]; const seen=new Set(); const q=[json];
          try{
            while(q.length){
              const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
              for(const v of Object.values(cur)){
                if(Array.isArray(v)){
                  if(v.length && typeof v[0]==='object') out.push(...v);
                  v.forEach(x=>{ if(x && typeof x==='object') q.push(x); });
                  continue;
                }
                if(typeof v==='string'){
                  try{ const j = JSON.parse(v); if(j){ q.push(j); continue; } }catch(_){ }
                }
                if(v && typeof v==='object') q.push(v);
              }
            }
          }catch(_){ }
          return out.length? out: (typeof json==='object'? [json]: []);
        }
        
        const rows = collectRowsDeep(parsed ?? (txt? JSON.parse(txt): null));
        
        function lowerKeyMap(obj){
          const map={};
          try{ Object.keys(obj||{}).forEach(k=>{ map[String(k).toLowerCase()] = obj[k]; }); }catch(_){ }
          return map;
        }
        
        function getFrom(lowerObj, ...keys){
          for(const k of keys){
            const kk = String(k||'').toLowerCase();
            if (lowerObj.hasOwnProperty(kk)) return lowerObj[kk];
          }
          return '';
        }
        
        const normalized = rows.map(x=>{
          const lx = lowerKeyMap(x||{});
          return {
            id: getFrom(lx,'id','ID'),
            code: getFrom(lx,'m√£ t√°c v·ª•','code','ma','taskcode'),
            title: getFrom(lx,'t√™n t√°c v·ª•','title','name','t√™n'),
            requester: getFrom(lx,'ng∆∞·ªùi y√™u c·∫ßu','requester','nguoiyc'),
            // Map ƒë√∫ng theo json.json: "Ng√†y y√™u c·∫ßu c·ªßa c√°c b√™n"
            requestDate: getFrom(lx,'ng√†y y√™u c·∫ßu c·ªßa c√°c b√™n','ng√†y y√™u c·∫ßu','requestdate','ngayyeucau'),
            // Map ƒë√∫ng theo json.json: "H·∫°n mong mu·ªën c·ªßa c√°c b√™n"
            wishDate: getFrom(lx,'h·∫°n mong mu·ªën c·ªßa c√°c b√™n','h·∫°n mong mu·ªën','wishdate','hanmongmuon'),
            // Tr∆∞·ªùng quan tr·ªçng: "Ng∆∞·ªùi th·ª±c hi·ªán" - d√πng ƒë·ªÉ ph√¢n lo·∫°i
            assignee: getFrom(lx,'ng∆∞·ªùi th·ª±c hi·ªán','assignee','nguoithuchien','reporter'),
            status: getFrom(lx,'k·∫øt qu·∫£','tr·∫°ng th√°i','status','trangthai','ketqua'),
            note: getFrom(lx,'ghi ch√∫ c·ªßa y√™u c·∫ßu','ghi ch√∫ b√°o c√°o','ghi ch√∫','note','ghichu'),
            // Gi·ªØ to√†n b·ªô d·ªØ li·ªáu g·ªëc (theo ƒë√∫ng c·∫•u tr√∫c json.json)
            raw: x
          };
        });
        
        return normalized.filter(r=> r.id || r.code || r.title);
      }catch(err){
        console.error('[Assign] Fetch error:', err);
        return [];
      }
    }

    function applyAssignFilters(all, tab){
      const q = (document.getElementById('assign-flt-q')?.value || '').trim().toLowerCase();
      const from = parseDateFlexible(document.getElementById('assign-flt-from')?.value || '');
      const to = parseDateFlexible(document.getElementById('assign-flt-to')?.value || '');
      
      return all.filter(it=>{
        // L·ªçc theo tab
        const hasAssignee = String(it.assignee||'').trim().length > 0;
        if (tab === 'unassigned' && hasAssignee) return false;
        if (tab === 'assigned' && !hasAssignee) return false;
        
        // L·ªçc theo t·ª´ kh√≥a
        if (q){
          const searchText = [it.code, it.title, it.requester].join(' ').toLowerCase();
          if (!searchText.includes(q)) return false;
        }
        
        // L·ªçc theo ng√†y
        const reqDate = parseDateFlexible(it.requestDate);
        if (from && reqDate){
          if (reqDate.getTime() < new Date(from.getFullYear(), from.getMonth(), from.getDate()).getTime()) return false;
        }
        if (to && reqDate){
          if (reqDate.getTime() > new Date(to.getFullYear(), to.getMonth(), to.getDate(), 23, 59, 59, 999).getTime()) return false;
        }
        
        return true;
      });
    }

    function updateAssignPager(total){
      const pager = document.getElementById('assign-pager');
      const info = document.getElementById('assign-page-info');
      const ps = ASSIGN_PAGE_SIZE;
      const pages = Math.max(1, Math.ceil(total/ps));
      if (ASSIGN_CURRENT_PAGE > pages) ASSIGN_CURRENT_PAGE = pages;
      if (info) info.textContent = `Trang ${ASSIGN_CURRENT_PAGE}/${pages} (${total} d√≤ng)`;
      if (pager) pager.style.display = total>0 ? 'flex' : 'none';
    }

    function renderAssignTable(){
      const body = document.getElementById('assign-list-body');
      if (!body) return;
      
      const total = ASSIGN_FILTERED.length;
      updateAssignPager(total);
      
      if (!total){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        return;
      }
      
      const start = (ASSIGN_CURRENT_PAGE-1)*ASSIGN_PAGE_SIZE;
      const end = Math.min(total, start+ASSIGN_PAGE_SIZE);
      const pageItems = ASSIGN_FILTERED.slice(start, end);
      
      body.innerHTML = pageItems.map(it=>{
        const hasAssignee = String(it.assignee||'').trim().length > 0;
        const statusBadge = hasAssignee 
          ? '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-50 text-green-700 border border-green-200">ƒê√£ ph√¢n c√¥ng</span>'
          : '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-200">Ch∆∞a ph√¢n c√¥ng</span>';
        
        return `
          <tr>
            <td class="px-3 py-2"><span class="font-medium">${it.code || ''}</span></td>
            <td class="px-3 py-2">${it.title || ''}</td>
            <td class="px-3 py-2">${it.requester || ''}</td>
            <td class="px-3 py-2">${fmtDmy(it.requestDate)}</td>
            <td class="px-3 py-2">${fmtDmy(it.wishDate)}</td>
            <td class="px-3 py-2">${it.assignee || '<span class="text-gray-400">Ch∆∞a c√≥</span>'}</td>
            <td class="px-3 py-2">${statusBadge}</td>
            <td class="px-3 py-2">
              <div class="flex items-center gap-2">
                ${!hasAssignee ? `<button class="px-3 py-1 rounded-full text-white font-semibold bg-primary-blue hover:brightness-105 act-assign" data-id="${it.id || it.code}">Ph√¢n c√¥ng</button>` : `<button class="px-3 py-1 rounded-full text-white font-semibold bg-amber-500 hover:brightness-105 act-change-assign" data-id="${it.id || it.code}">Thay ƒë·ªïi</button>`}
                <button class="px-3 py-1 rounded-full text-white font-semibold bg-gray-500 hover:brightness-105 act-view-detail" data-id="${it.id || it.code}">Chi ti·∫øt</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function updateAssignCounts(){
      const unassigned = ASSIGN_FILTERED.filter(it=> !String(it.assignee||'').trim().length).length;
      const assigned = ASSIGN_FILTERED.filter(it=> String(it.assignee||'').trim().length > 0).length;
      
      const unassignedEl = document.getElementById('count-unassigned');
      const assignedEl = document.getElementById('count-assigned');
      if (unassignedEl) unassignedEl.textContent = unassigned;
      if (assignedEl) assignedEl.textContent = assigned;
    }

    async function reloadAssign(){
      const btn = document.getElementById('btn-reload-assign');
      const prev = btn?.textContent || '';
      if (btn) { btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i..."; }
      
      try{
        const items = await fetchAssignData();
        ALL_ASSIGN_ITEMS = Array.isArray(items) ? items : [];
        ASSIGN_FILTERED = applyAssignFilters(ALL_ASSIGN_ITEMS, ASSIGN_CURRENT_TAB);
        ASSIGN_CURRENT_PAGE = 1;
        updateAssignCounts();
        renderAssignTable();
      }catch(err){
        showToast('L·ªói t·∫£i d·ªØ li·ªáu ph√¢n c√¥ng.', 'error');
      }finally{
        if (btn) { btn.disabled = false; btn.textContent = prev || 'üîÑ L√†m m·ªõi'; }
      }
    }

    function switchAssignTab(tab){
      ASSIGN_CURRENT_TAB = tab;
      document.querySelectorAll('.assign-tab-btn').forEach(btn => {
        btn.classList.remove('active', 'border-primary-blue');
        if (btn.getAttribute('data-tab') === tab) {
          btn.classList.add('active', 'border-primary-blue');
        }
      });
      ASSIGN_FILTERED = applyAssignFilters(ALL_ASSIGN_ITEMS, tab);
      ASSIGN_CURRENT_PAGE = 1;
      updateAssignCounts();
      renderAssignTable();
    }

    function populateAssignPersonSelect(){
      const select = document.getElementById('assign-person');
      if (!select) return;
      
      select.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán --</option>';
      NHOM_NCTN2.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
    }

    async function doAssign(){
      const btn = document.getElementById('assign-do');
      if (!ASSIGN_CURRENT_ITEM || !btn) return;
      
      const prev = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
      
      const person = document.getElementById('assign-person')?.value || '';
      const note = document.getElementById('assign-note')?.value || '';
      
      if (!person){
        showToast('Vui l√≤ng ch·ªçn ng∆∞·ªùi th·ª±c hi·ªán', 'error');
        btn.disabled = false;
        btn.textContent = prev;
        return;
      }
      
      try{
        const it = ALL_ASSIGN_ITEMS.find(x=> String(x.id)===String(ASSIGN_CURRENT_ITEM) || String(x.code)===String(ASSIGN_CURRENT_ITEM));
        if (!it) throw new Error('Kh√¥ng t√¨m th·∫•y t√°c v·ª•');
        
        const p = new URLSearchParams();
        
        // G·ª≠i t·∫•t c·∫£ d·ªØ li·ªáu g·ªëc t·ª´ raw object (theo ƒë√∫ng c·∫•u tr√∫c json.json)
        if (it.raw) {
          try{
            Object.keys(it.raw).forEach(k => {
              const v = it.raw[k];
              // B·ªè qua c√°c tr∆∞·ªùng null ho·∫∑c undefined, nh∆∞ng gi·ªØ l·∫°i chu·ªói r·ªóng n·∫øu c·∫ßn
              if (v !== null && v !== undefined) {
                p.set(k, String(v));
              }
            });
          }catch(_){}
        }
        
        // ƒê·∫£m b·∫£o c√≥ c√°c tr∆∞·ªùng b·∫Øt bu·ªôc n·∫øu raw kh√¥ng c√≥
        if (!it.raw || !it.raw['Id']) {
          if (it.id) p.set('Id', String(it.id));
        }
        if (!it.raw || !it.raw['M√£ t√°c v·ª•']) {
          if (it.code) p.set('M√£ t√°c v·ª•', String(it.code));
        }
        if (!it.raw || !it.raw['T√™n t√°c v·ª•']) {
          if (it.title) p.set('T√™n t√°c v·ª•', String(it.title));
        }
        
        // L·∫•y ng∆∞·ªùi th·ª±c hi·ªán tr∆∞·ªõc ƒë√≥ (n·∫øu c√≥, n·∫øu kh√¥ng th√¨ null)
        const previousAssignee = (ASSIGN_IS_CHANGE_MODE && (it.assignee || (it.raw && it.raw['Ng∆∞·ªùi th·ª±c hi·ªán']))) 
          ? (it.assignee || it.raw['Ng∆∞·ªùi th·ª±c hi·ªán']) 
          : null;
        
        // C·∫≠p nh·∫≠t tr∆∞·ªùng "Ng∆∞·ªùi th·ª±c hi·ªán" (theo ƒë√∫ng t√™n tr∆∞·ªùng trong json.json)
        // D√πng set() ƒë·ªÉ ghi ƒë√® gi√° tr·ªã c≈© n·∫øu c√≥
        p.set('Ng∆∞·ªùi th·ª±c hi·ªán', person);
        
        // Lu√¥n th√™m ng∆∞·ªùi th·ª±c hi·ªán tr∆∞·ªõc ƒë√≥ (r·ªóng n·∫øu ph√¢n c√¥ng m·ªõi)
        p.set('Ng∆∞·ªùi th·ª±c hi·ªán tr∆∞·ªõc ƒë√≥', previousAssignee || '');
        
        // Th√™m th·ªùi gian t·∫°i th·ªùi ƒëi·ªÉm g·ª≠i
        const now = new Date();
        const timeISO = now.toISOString(); // Format: 2026-01-20T10:30:00.000Z
        const timeVi = nowViMinute(); // Format: 20/01/2026 10:30
        const timeViFull = now.toLocaleString('vi-VN', { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: '2-digit', 
          minute: '2-digit', 
          second: '2-digit',
          timeZone: 'Asia/Ho_Chi_Minh'
        });
        
        p.set('Th·ªùi gian ph√¢n c√¥ng', timeVi);
        p.set('Th·ªùi gian ph√¢n c√¥ng (ISO)', timeISO);
        p.set('Th·ªùi gian ph√¢n c√¥ng (ƒë·∫ßy ƒë·ªß)', timeViFull);
        p.set('Ng√†y gi·ªù ph√¢n c√¥ng', timeISO);
        
        // C·∫≠p nh·∫≠t ghi ch√∫ n·∫øu c√≥ (theo json.json c√≥ th·ªÉ l√† "Ghi ch√∫ c·ªßa y√™u c·∫ßu")
        if (note) {
          p.set('Ghi ch√∫ c·ªßa y√™u c·∫ßu', note);
        }
        
        // Th√™m action ƒë·ªÉ server bi·∫øt ƒë√¢y l√† thao t√°c ph√¢n c√¥ng/thay ƒë·ªïi
        p.set('action', ASSIGN_IS_CHANGE_MODE ? 'change_assignee' : 'assign_task');
        
        // Log ƒë·ªÉ debug
        console.log('[Assign] Sending data:', {
          id: it.id || it.code,
          code: it.code,
          title: it.title,
          assignee: person,
          previousAssignee: previousAssignee,
          isChange: ASSIGN_IS_CHANGE_MODE,
          timeSent: timeVi,
          hasRaw: !!it.raw,
          rawKeys: it.raw ? Object.keys(it.raw).length : 0
        });
        
        async function tryPost(url){
          try{
            console.log('[Assign] Sending to:', url);
            console.log('[Assign] Params:', Array.from(p.entries()));
            
            const r = await fetch(url, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: p.toString(),
              cache: 'no-store'
            });
            const t = await r.text();
            console.log('[Assign] Response status:', r.status);
            console.log('[Assign] Response body:', t);
            
            return { ok: r.ok, raw: t, status: r.status, url: url };
          }catch(err){
            console.error('[Assign] Fetch error:', err);
            return { ok: false, raw: String(err||''), status: 0, url: url };
          }
        }
        
        // Th·ª≠ c·∫£ test URL v√† production URL
        const ASSIGN_ACTION_URL_PROD = 'https://xcqiyibqs.tino.page/webhook/doinguoiphancongnctn2';
        const ASSIGN_ACTION_URL_TEST = 'https://xcqiyibqs.tino.page/webhook-test/doinguoiphancongnctn2';
        
        let r = await tryPost(ASSIGN_ACTION_URL_PROD);
        
        // N·∫øu production URL kh√¥ng th√†nh c√¥ng, th·ª≠ test URL
        if (!r.ok && r.status !== 200) {
          console.log('[Assign] Production URL failed, trying test URL...');
          r = await tryPost(ASSIGN_ACTION_URL_TEST);
        }
        
        // Ki·ªÉm tra response
        if (!r.ok || r.status < 200 || r.status >= 300) {
          let errorMsg = r.raw || `HTTP ${r.status}`;
          
          // Parse error message n·∫øu c√≥
          try {
            const errorJson = JSON.parse(r.raw);
            if (errorJson.message) errorMsg = errorJson.message;
            else if (errorJson.error) errorMsg = errorJson.error;
          } catch(_) {
            // N·∫øu kh√¥ng parse ƒë∆∞·ª£c JSON, d√πng raw text
            if (r.raw && r.raw.length > 0 && r.raw.length < 500) {
              errorMsg = r.raw;
            }
          }
          
          // Th√¥ng b√°o l·ªói chi ti·∫øt h∆°n
          if (r.status === 0) {
            errorMsg = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.';
          } else if (r.status >= 500) {
            errorMsg = `L·ªói server (${r.status}): ${errorMsg}`;
          } else if (r.status >= 400) {
            errorMsg = `L·ªói request (${r.status}): ${errorMsg}`;
          }
          
          throw new Error(errorMsg);
        }
        
        // Ki·ªÉm tra response body c√≥ ch·ª©a l·ªói kh√¥ng
        let hasErrorInResponse = false;
        if (r.raw && typeof r.raw === 'string') {
          const lowerRaw = r.raw.toLowerCase();
          if (lowerRaw.includes('error') || lowerRaw.includes('l·ªói') || lowerRaw.includes('failed') || lowerRaw.includes('unused')) {
            // C√≥ th·ªÉ c√≥ l·ªói trong response d√π status code l√† 200
            console.warn('[Assign] Warning in response:', r.raw);
            // Ki·ªÉm tra xem c√≥ ph·∫£i l·ªói nghi√™m tr·ªçng kh√¥ng
            if (lowerRaw.includes('unused respond to webhook') || lowerRaw.includes('error') || lowerRaw.includes('failed')) {
              hasErrorInResponse = true;
            }
          }
        }
        
        // Ch·ªâ reload khi response th√†nh c√¥ng v√† kh√¥ng c√≥ l·ªói
        if (!hasErrorInResponse) {
          closeModal('modal-assign');
          const actionText = ASSIGN_IS_CHANGE_MODE ? 'ƒë√£ thay ƒë·ªïi ng∆∞·ªùi th·ª±c hi·ªán th√†nh' : 'ƒë√£ ph√¢n c√¥ng cho';
          showToast(`${actionText.charAt(0).toUpperCase() + actionText.slice(1)} ${person}`, 'success');
          
          // ƒê·ª£i response th√†nh c√¥ng r·ªìi m·ªõi reload l·∫°i b·∫£ng
          await reloadAssign();
        } else {
          // N·∫øu c√≥ l·ªói trong response, throw error ƒë·ªÉ v√†o catch block
          throw new Error(r.raw || 'L·ªói t·ª´ server');
        }
      }catch(err){
        const errorMsg = err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
        console.error('[Assign] Error:', err);
        console.error('[Assign] Request params:', p ? Array.from(p.entries()) : 'N/A');
        
        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói chi ti·∫øt h∆°n
        let userMsg = errorMsg;
        if (errorMsg.includes('Unused Respond to Webhook')) {
          userMsg = 'L·ªói c·∫•u h√¨nh webhook tr√™n server. Vui l√≤ng li√™n h·ªá qu·∫£n tr·ªã vi√™n ƒë·ªÉ ki·ªÉm tra workflow.';
        } else if (errorMsg.includes('kh√¥ng th·ªÉ k·∫øt n·ªëi')) {
          userMsg = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† th·ª≠ l·∫°i.';
        } else if (errorMsg.includes('500')) {
          userMsg = 'L·ªói server. Vui l√≤ng th·ª≠ l·∫°i sau ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.';
        } else if (errorMsg.includes('400')) {
          userMsg = 'D·ªØ li·ªáu g·ª≠i kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.';
        }
        
        showToast('L·ªói: ' + userMsg, 'error');
        
        // Hi·ªÉn th·ªã chi ti·∫øt trong console ƒë·ªÉ debug
        console.error('[Assign] Full error details:', {
          message: errorMsg,
          item: it,
          params: p ? Object.fromEntries(p.entries()) : null
        });
      }finally{
        btn.disabled = false;
        btn.textContent = prev || 'X√°c nh·∫≠n';
      }
    }

    // ===== Tab Switching
    function switchTab(targetId){
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-target') === targetId) {
          btn.classList.add('active');
        }
      });
      
      document.querySelectorAll('section[id^="form-"]').forEach(section => {
        section.style.display = 'none';
      });
      
      const targetSection = document.getElementById(targetId);
      if (targetSection) {
        targetSection.style.display = 'block';
        if (targetId === 'form-statistics') {
          loadStatistics();
        } else if (targetId === 'form-assign') {
          if (ALL_ASSIGN_ITEMS.length === 0) {
            reloadAssign();
          } else {
            ASSIGN_FILTERED = applyAssignFilters(ALL_ASSIGN_ITEMS, ASSIGN_CURRENT_TAB);
            ASSIGN_CURRENT_PAGE = 1;
            updateAssignCounts();
            renderAssignTable();
          }
        }
      }
    }

    // ===== Events & Init
    (function init(){
      document.querySelectorAll('.modal').forEach(m=>{
        m.addEventListener('click', (e)=>{ if (e.target === m) closeModal(m.id); });
      });
      document.querySelectorAll('[data-close]').forEach(b=>{
        b.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(b.getAttribute('data-close')||''); });
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal.open').forEach(m=> closeModal(m.id)); } });

      // Tab switching
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const target = btn.getAttribute('data-target');
          if (target) switchTab(target);
        });
      });

      // Statistics events
      document.getElementById('btn-refresh-stats')?.addEventListener('click', () => {
        loadStatistics();
        showToast('ƒê√£ l√†m m·ªõi th·ªëng k√™', 'success');
      });

      document.getElementById('btn-apply-stats')?.addEventListener('click', () => {
        loadStatistics();
      });

      // Set default date range for statistics
      try{
        const statsFrom = document.getElementById('stats-from');
        const statsTo = document.getElementById('stats-to');
        if (statsFrom && statsTo) {
          const now = new Date();
          const start = new Date(now.getFullYear(), now.getMonth(), 1);
          const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          const toISO = (x) => `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`;
          statsFrom.value = toISO(start);
          statsTo.value = toISO(end);
        }
      }catch(_){}

      // Assign events
      document.getElementById('btn-reload-assign')?.addEventListener('click', () => {
        reloadAssign();
      });

      document.querySelectorAll('.assign-tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const tab = btn.getAttribute('data-tab');
          if (tab) switchAssignTab(tab);
        });
      });

      document.getElementById('assign-flt-q')?.addEventListener('input', () => {
        ASSIGN_FILTERED = applyAssignFilters(ALL_ASSIGN_ITEMS, ASSIGN_CURRENT_TAB);
        ASSIGN_CURRENT_PAGE = 1;
        updateAssignCounts();
        renderAssignTable();
      });

      document.getElementById('assign-flt-from')?.addEventListener('change', () => {
        ASSIGN_FILTERED = applyAssignFilters(ALL_ASSIGN_ITEMS, ASSIGN_CURRENT_TAB);
        ASSIGN_CURRENT_PAGE = 1;
        updateAssignCounts();
        renderAssignTable();
      });

      document.getElementById('assign-flt-to')?.addEventListener('change', () => {
        ASSIGN_FILTERED = applyAssignFilters(ALL_ASSIGN_ITEMS, ASSIGN_CURRENT_TAB);
        ASSIGN_CURRENT_PAGE = 1;
        updateAssignCounts();
        renderAssignTable();
      });

      document.getElementById('assign-page-size')?.addEventListener('change', (e) => {
        ASSIGN_PAGE_SIZE = Number(e.target.value || 20) || 20;
        ASSIGN_CURRENT_PAGE = 1;
        renderAssignTable();
      });

      document.getElementById('assign-prev')?.addEventListener('click', () => {
        if (ASSIGN_CURRENT_PAGE > 1) {
          ASSIGN_CURRENT_PAGE--;
          renderAssignTable();
        }
      });

      document.getElementById('assign-next')?.addEventListener('click', () => {
        const pages = Math.max(1, Math.ceil(ASSIGN_FILTERED.length / ASSIGN_PAGE_SIZE));
        if (ASSIGN_CURRENT_PAGE < pages) {
          ASSIGN_CURRENT_PAGE++;
          renderAssignTable();
        }
      });

      // Event delegation cho b·∫£ng ph√¢n c√¥ng
      const assignBody = document.getElementById('assign-list-body');
      if (assignBody) {
        assignBody.addEventListener('click', (e) => {
          const btn = e.target.closest('button');
          if (!btn) return;
          
          const id = btn.getAttribute('data-id');
          if (!id) return;
          
          if (btn.classList.contains('act-assign') || btn.classList.contains('act-change-assign')) {
            ASSIGN_CURRENT_ITEM = id;
            ASSIGN_IS_CHANGE_MODE = btn.classList.contains('act-change-assign');
            const it = ALL_ASSIGN_ITEMS.find(x => String(x.id) === String(id) || String(x.code) === String(id));
            if (it) {
              // C·∫≠p nh·∫≠t modal
              const titleEl = document.getElementById('assign-modal-title');
              const currentPersonContainer = document.getElementById('assign-current-person-container');
              const currentPersonEl = document.getElementById('assign-current-person');
              const personSelect = document.getElementById('assign-person');
              const noteEl = document.getElementById('assign-note');
              const btnDo = document.getElementById('assign-do');
              
              document.getElementById('assign-task-code').value = it.code || '';
              document.getElementById('assign-task-title').value = it.title || '';
              
              if (ASSIGN_IS_CHANGE_MODE) {
                // Ch·∫ø ƒë·ªô thay ƒë·ªïi
                if (titleEl) titleEl.textContent = 'Thay ƒë·ªïi ng∆∞·ªùi th·ª±c hi·ªán';
                if (currentPersonContainer) currentPersonContainer.style.display = 'block';
                if (currentPersonEl) currentPersonEl.value = it.assignee || 'Ch∆∞a c√≥';
                if (personSelect) personSelect.value = it.assignee || '';
                if (noteEl) noteEl.value = it.note || '';
                if (btnDo) btnDo.textContent = 'X√°c nh·∫≠n thay ƒë·ªïi';
              } else {
                // Ch·∫ø ƒë·ªô ph√¢n c√¥ng m·ªõi
                if (titleEl) titleEl.textContent = 'Ph√¢n c√¥ng t√°c v·ª•';
                if (currentPersonContainer) currentPersonContainer.style.display = 'none';
                if (personSelect) personSelect.value = '';
                if (noteEl) noteEl.value = '';
                if (btnDo) btnDo.textContent = 'X√°c nh·∫≠n ph√¢n c√¥ng';
              }
              
              populateAssignPersonSelect();
              // ƒê·∫∑t l·∫°i gi√° tr·ªã ng∆∞·ªùi th·ª±c hi·ªán sau khi populate n·∫øu l√† ch·∫ø ƒë·ªô thay ƒë·ªïi
              if (ASSIGN_IS_CHANGE_MODE && personSelect && it.assignee) {
                personSelect.value = it.assignee;
              }
              
              openModal('modal-assign');
            }
          } else if (btn.classList.contains('act-view-detail')) {
            // C√≥ th·ªÉ m·ªü modal chi ti·∫øt ho·∫∑c xem th√¥ng tin
            const it = ALL_ASSIGN_ITEMS.find(x => String(x.id) === String(id) || String(x.code) === String(id));
            if (it) {
              let detail = `M√£: ${it.code}\nT√™n: ${it.title}\nNg∆∞·ªùi y√™u c·∫ßu: ${it.requester}\nNg√†y y√™u c·∫ßu: ${fmtDmy(it.requestDate)}\nH·∫°n mong mu·ªën: ${fmtDmy(it.wishDate)}\nNg∆∞·ªùi th·ª±c hi·ªán: ${it.assignee || 'Ch∆∞a c√≥'}\nTr·∫°ng th√°i: ${it.status || ''}`;
              if (it.note) detail += `\nGhi ch√∫: ${it.note}`;
              alert(detail);
            }
          }
        });
      }

      document.getElementById('assign-do')?.addEventListener('click', (e) => {
        e.preventDefault();
        doAssign();
      });

      populateAssignPersonSelect();

      // Set default date range for assign
      try{
        const assignFrom = document.getElementById('assign-flt-from');
        const assignTo = document.getElementById('assign-flt-to');
        if (assignFrom && assignTo) {
          const now = new Date();
          const start = new Date(now.getFullYear(), now.getMonth(), 1);
          const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
          const toISO = (x) => `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`;
          assignFrom.value = toISO(start);
          assignTo.value = toISO(end);
        }
      }catch(_){}

      (function enforceSecretLock(){
        try{
          const input = document.getElementById('secret-code');
          const disableAll = (disabled)=>{
            document.querySelectorAll('button, input, select, textarea, a').forEach(el=>{
              if (el===input) return;
              if (disabled){ el.setAttribute('disabled','true'); el.classList.add('opacity-60','pointer-events-none'); }
              else { el.removeAttribute('disabled'); el.classList.remove('opacity-60','pointer-events-none'); }
            });
          };
          const update = ()=>{
            const raw = String(input?.value||'');
            const norm = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase();
            const has = ['vietvip'].includes(norm);
            disableAll(!has);
          };
          update();
          input?.addEventListener('input', ()=>{ update(); });
        }catch(_){ }
      })();

      document.querySelectorAll('.group-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.preventDefault();
          const group = btn.getAttribute('data-group');
          SELECTED_GROUP = group || 'all';
          document.querySelectorAll('.group-btn').forEach(b=> b.classList.remove('active'));
          btn.classList.add('active');
          FILTERED = applyFilters(ALL_ITEMS);
          CURRENT_PAGE = 1;
          renderTable();
        });
      });

      const body = document.getElementById('list-body');
      body.addEventListener('click', (e)=>{
        const link = e.target.closest('.report-link');
        if (link){ e.preventDefault(); const rid=link.getAttribute('data-id'); if (rid) openReportPreview(rid); return; }
        const tLink = e.target.closest('.task-detail-link');
        if (tLink){ e.preventDefault(); const rid=tLink.getAttribute('data-id'); if (rid) openTaskDetail(rid); return; }
        const btn = e.target.closest('button'); if (!btn) return;
        const id = btn.getAttribute('data-id'); if (!id) return; CURRENT_ITEM_ID = id;
        if (btn.classList.contains('act-approve')){ CURRENT_ACTION='approve'; (document.getElementById('approve-comment')||{}).value=''; openModal('modal-approve'); return; }
        if (btn.classList.contains('act-reject')){ CURRENT_ACTION='reject'; (document.getElementById('reject-reason')||{}).value=''; openModal('modal-reject'); return; }
        if (btn.classList.contains('act-request')){ CURRENT_ACTION='request'; (document.getElementById('req-comment')||{}).value=''; (document.getElementById('req-due')||{}).value=''; openModal('modal-req'); return; }
      });

      document.getElementById('approve-do')?.addEventListener('click', (e)=>{ e.preventDefault(); doApprove(); });
      document.getElementById('reject-do')?.addEventListener('click', (e)=>{ e.preventDefault(); doReject(); });
      document.getElementById('req-do')?.addEventListener('click', (e)=>{ e.preventDefault(); doRequest(); });

      document.getElementById('btn-search')?.addEventListener('click', async (e)=>{ e.preventDefault(); await reload(); });
      try{
          const secCode = document.getElementById('secret-code');
          try{ localStorage.removeItem('tn_secret_code'); }catch(_){ }
          if (secCode){ secCode.value = ''; secCode.addEventListener('input', ()=>{ localStorage.setItem('tn_secret_code', secCode.value||''); }); }
          const toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.textContent = 'Hi·ªán';
          toggle.className = 'px-2 py-0.5 rounded border border-gray-300 bg-white hover:bg-gray-50';
          const headerRight = secCode?.parentElement;
          if (secCode && headerRight){ headerRight.insertBefore(toggle, secCode.nextSibling); }
          toggle?.addEventListener('click', ()=>{
            if (!secCode) return;
            const cur = secCode.getAttribute('type');
            secCode.setAttribute('type', cur==='password'?'text':'password');
            toggle.textContent = cur==='password'?'·∫®n':'Hi·ªán';
          });
        }catch(_){ }
      document.getElementById('btn-reset')?.addEventListener('click', async (e)=>{
        e.preventDefault(); 
        ['flt-q','flt-status','flt-from','flt-to'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if (el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }); 
        SELECTED_GROUP = 'all';
        document.querySelectorAll('.group-btn').forEach(b=> b.classList.remove('active'));
        document.getElementById('btn-group-all')?.classList.add('active');
        await reload();
      });
      document.getElementById('flt-mode')?.addEventListener('change', (e)=>{ applyQuickRangeLocal(e.target.value||'All'); });
      document.getElementById('flt-from')?.addEventListener('change', ()=>{ filterTimeInPlace(); });
      document.getElementById('flt-to')?.addEventListener('change', ()=>{ filterTimeInPlace(); });
      document.getElementById('page-size')?.addEventListener('change', (e)=>{ PAGE_SIZE = Number(e.target.value||20)||20; CURRENT_PAGE=1; renderTable(); });
      document.getElementById('prev')?.addEventListener('click', ()=>{ if (CURRENT_PAGE>1){ CURRENT_PAGE--; renderTable(); } });
      document.getElementById('next')?.addEventListener('click', ()=>{ const pages=Math.max(1,Math.ceil(FILTERED.length/PAGE_SIZE)); if (CURRENT_PAGE<pages){ CURRENT_PAGE++; renderTable(); } });

      try{
        const fromEl=document.getElementById('flt-from');
        const toEl=document.getElementById('flt-to');
        const now=new Date();
        const start=new Date(now.getFullYear(), now.getMonth(), 1);
        const end=new Date(now.getFullYear(), now.getMonth()+1, 0);
        const toISO=(x)=>`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`;
        if(fromEl) fromEl.value = toISO(start);
        if(toEl) toEl.value = toISO(end);
        const stSel=document.getElementById('flt-status'); if (stSel){ stSel.value = 'Pending2'; }
      }catch(_){ }
      reload();
    })();

    async function reload(){
      const btn = document.getElementById('btn-search'); const prev = btn?btn.textContent:''; if(btn){ btn.disabled=true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i..."; }
      try{
        const params = {
          q: document.getElementById('flt-q')?.value||'',
          status: document.getElementById('flt-status')?.value||'',
          from: document.getElementById('flt-from')?.value||'',
          to: document.getElementById('flt-to')?.value||'',
          mode: document.getElementById('flt-mode')?.value||'All',
          page: CURRENT_PAGE,
          pageSize: PAGE_SIZE
        };
        const items = await fetchReports(params);
        ALL_ITEMS = Array.isArray(items) ? items : [];
        FILTERED = applyFilters(ALL_ITEMS);
        CURRENT_PAGE = 1;
        renderTable();
        
        // C·∫≠p nh·∫≠t th·ªëng k√™ n·∫øu ƒëang ·ªü tab th·ªëng k√™
        const statsSection = document.getElementById('form-statistics');
        if (statsSection && statsSection.style.display !== 'none') {
          loadStatistics();
        }
      }catch(err){
        showToast('L·ªói t·∫£i d·ªØ li·ªáu.','error');
      }finally{ if(btn){ btn.disabled=false; btn.textContent = prev||'Tra c·ª©u'; } }
    }

    function applyQuickRange(mode){
      const fromEl = document.getElementById('flt-from'); const toEl = document.getElementById('flt-to'); if(!fromEl||!toEl) return;
      const d = new Date();
      function toISO(x){ const yy=x.getFullYear(); const mm=String(x.getMonth()+1).padStart(2,'0'); const dd=String(x.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; }
      if (mode==='All'){ fromEl.value=''; toEl.value=''; reload(); return; }
      if (mode==='Day'){ const s=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const e=new Date(d.getFullYear(), d.getMonth(), d.getDate()); fromEl.value=toISO(s); toEl.value=toISO(e); reload(); return; }
      if (mode==='Week'){ const day=d.getDay()||7; const s=new Date(d); s.setDate(d.getDate() - (day-1)); const e=new Date(s); e.setDate(s.getDate()+6); fromEl.value=toISO(s); toEl.value=toISO(e); reload(); return; }
      if (mode==='Month'){ const s=new Date(d.getFullYear(), d.getMonth(), 1); const e=new Date(d.getFullYear(), d.getMonth()+1, 0); fromEl.value=toISO(s); toEl.value=toISO(e); reload(); return; }
    }

    function filterTimeInPlace(){
      try{ FILTERED = applyFilters(ALL_ITEMS); CURRENT_PAGE=1; renderTable(); }catch(_){ }
    }

    function applyQuickRangeLocal(mode){
      const fromEl = document.getElementById('flt-from'); const toEl = document.getElementById('flt-to'); if(!fromEl||!toEl) return;
      const d = new Date();
      function toISO(x){ const yy=x.getFullYear(); const mm=String(x.getMonth()+1).padStart(2,'0'); const dd=String(x.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; }
      if (mode==='All'){ fromEl.value=''; toEl.value=''; filterTimeInPlace(); return; }
      if (mode==='Day'){ const s=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const e=new Date(d.getFullYear(), d.getMonth(), d.getDate()); fromEl.value=toISO(s); toEl.value=toISO(e); filterTimeInPlace(); return; }
      if (mode==='Week'){ const day=d.getDay()||7; const s=new Date(d); s.setDate(d.getDate() - (day-1)); const e=new Date(s); e.setDate(s.getDate()+6); fromEl.value=toISO(s); toEl.value=toISO(e); filterTimeInPlace(); return; }
      if (mode==='Month'){ const s=new Date(d.getFullYear(), d.getMonth(), 1); const e=new Date(d.getFullYear(), d.getMonth()+1, 0); fromEl.value=toISO(s); toEl.value=toISO(e); filterTimeInPlace(); return; }
    }
  </script>
</body>
</html>
